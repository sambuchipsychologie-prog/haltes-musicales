import React, { useState, useEffect } from 'react';
import { Calendar, LogOut, Plus, Save, BarChart3, Trash2, Edit2, FileText, X, UserPlus, Users } from 'lucide-react';

const USERS = [
  { email: 'prof1@haltes-musicales.fr', password: 'HM2024prof1', name: 'Professionnel 1', id: 'prof1' },
  { email: 'prof2@haltes-musicales.fr', password: 'HM2024prof2', name: 'Professionnel 2', id: 'prof2' },
  { email: 'prof3@haltes-musicales.fr', password: 'HM2024prof3', name: 'Professionnel 3', id: 'prof3' },
  { email: 'prof4@haltes-musicales.fr', password: 'HM2024prof4', name: 'Professionnel 4', id: 'prof4' },
  { email: 'prof5@haltes-musicales.fr', password: 'HM2024prof5', name: 'Professionnel 5', id: 'prof5' }
];

const EVALUATION_STRUCTURE = {
  interactionsSociales: {
    title: "INTERACTIONS SOCIALES",
    items: [
      { key: "interaction", label: "Interaction Sociale (√©changes entre r√©sidents et/ou soignants)", moments: [1,2,3,4,5] },
      { key: "reactionEmotionnelle", label: "R√©action √©motionnelle positive (Expression faciale, Gestes)", moments: [1,2,3,4,5] }
    ]
  },
  communicationVerbale: {
    title: "COMMUNICATION VERBALE",
    items: [
      { key: "commMusiciens", label: "Communication avec les musiciens", moments: [2,3] },
      { key: "commResidents", label: "Communication avec les autres r√©sidents", moments: [2,3] }
    ]
  },
  stimulationSensorielle: {
    title: "STIMULATION MULTISENSORIELLE",
    items: [
      { key: "reactionAuditive", label: "R√©action auditive (r√©ceptivit√© √† la musique)", moments: [3] },
      { key: "reactionVisuelle", label: "R√©action visuelle (r√©ceptivit√© aux √©l√©ments visuels)", moments: [3] },
      { key: "reactionKinesth", label: "R√©action kinesth√©sique (mouvement, danse)", moments: [3] },
      { key: "receptiviteTactile", label: "R√©ceptivit√© tactile (interaction avec objets/personnes)", moments: [3] }
    ]
  },
  memoire: {
    title: "M√âMOIRE / SOUVENIRS",
    items: [
      { key: "reactivationSouvenirs", label: "R√©activation de souvenirs", moments: [3] },
      { key: "reconnaissanceMusique", label: "Reconnaissance de la musique", moments: [3] },
      { key: "verbalisationSouvenirs", label: "Niveau de verbalisation des souvenirs", moments: [3] }
    ]
  },
  comportements: {
    title: "COMPORTEMENTS",
    items: [
      { key: "agitation", label: "Agitation/Agressivit√©", moments: [1,2,3,4,5] },
      { key: "ideesDelirantes", label: "Id√©es d√©lirantes", moments: [1,2,3,4,5] },
      { key: "hallucinations", label: "Hallucinations", moments: [1,2,3,4,5] },
      { key: "depression", label: "D√©pression/Dysphorie", moments: [1,2,3,4,5] },
      { key: "anxiete", label: "Anxi√©t√©", moments: [1,2,3,4,5] },
      { key: "euphorie", label: "Exaltation de l'humeur / Euphorie", moments: [1,2,3,4,5] },
      { key: "apathie", label: "Apathie / Indiff√©rence", moments: [1,2,3,4,5] },
      { key: "desinhibition", label: "D√©sinhibition", moments: [1,2,3,4,5] },
      { key: "irritabilite", label: "Irritabilit√© / Instabilit√© de l'humeur", moments: [1,2,3,4,5] },
      { key: "moteurAberrant", label: "Comportement moteur aberrant", moments: [1,2,3,4,5] }
    ]
  },
  effetsGlobaux: {
    title: "EFFETS GLOBAUX",
    items: [
      { key: "reveilCognitif", label: "R√©veil cognitif", moments: [3,4,5] },
      { key: "ameliorationInteraction", label: "Am√©lioration de l'interaction sociale", moments: [3,4,5] },
      { key: "reductionAnxiete", label: "R√©duction de l'anxi√©t√© si pr√©sente", moments: [3,4,5] },
      { key: "reductionDepression", label: "R√©duction de la d√©pression si pr√©sente", moments: [3,4,5] }
    ]
  }
};

const MOMENT_LABELS = {
  1: "Habituellement",
  2: "Avant",
  3: "Pendant",
  4: "Apr√®s",
  5: "Suivi"
};

function createEmptyEvaluation() {
  return {
    id: Date.now().toString() + Math.random(),
    beneficiaire: { nom: '', prenom: '', dateNaissance: '', age: '', sexe: 'F√©minin' },
    pathologies: '',
    souhaitsMusicaux: '',
    objectifs: '',
    evaluations: {},
    commentaires: {},
    compteRenduHM: '',
    compteRenduEtablissement: ''
  };
}

export default function HaltesMusicalesApp() {
  const [currentUser, setCurrentUser] = useState(null);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loginError, setLoginError] = useState('');
  const [interventions, setInterventions] = useState({});
  const [showAddModal, setShowAddModal] = useState(false);
  const [notification, setNotification] = useState(null);
  const [newIntervention, setNewIntervention] = useState({
    date: '', time: '', lieu: '', notes: ''
  });

  useEffect(() => {
    if (currentUser) loadUserData();
  }, [currentUser]);

  const showNotif = (msg, type = 'success') => {
    setNotification({ msg, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const loadUserData = async () => {
    try {
      const data = await window.storage.get(`interventions_${currentUser.id}`);
      if (data) setInterventions(JSON.parse(data.value));
    } catch (e) {
      setInterventions({});
    }
  };

  const saveInterventions = async (data) => {
    try {
      await window.storage.set(`interventions_${currentUser.id}`, JSON.stringify(data));
    } catch (e) {
      console.error('Erreur sauvegarde:', e);
    }
  };

  const handleLogin = () => {
    const user = USERS.find(u => 
      u.email.toLowerCase() === email.trim().toLowerCase() && 
      u.password === password.trim()
    );
    if (user) {
      setCurrentUser(user);
      showNotif(`Bienvenue ${user.name} !`);
    } else {
      setLoginError('Identifiant incorrect');
    }
  };

  const handleQuickLogin = (user) => {
    setCurrentUser(user);
    showNotif(`Bienvenue ${user.name} !`);
  };

  const handleAddIntervention = async () => {
    if (!newIntervention.date || !newIntervention.time || !newIntervention.lieu) {
      showNotif('Remplissez date, heure et lieu', 'error');
      return;
    }

    const id = Date.now().toString();
    const updated = {
      ...interventions,
      [id]: { 
        ...newIntervention, 
        id, 
        createdAt: new Date().toISOString(),
        beneficiaires: []
      }
    };
    
    setInterventions(updated);
    await saveInterventions(updated);
    setShowAddModal(false);
    setNewIntervention({ date: '', time: '', lieu: '', notes: '' });
    showNotif('Intervention cr√©√©e !');
  };

  const handleDeleteIntervention = async (id) => {
    if (!confirm('Supprimer cette intervention et toutes ses √©valuations ?')) return;
    const updated = { ...interventions };
    delete updated[id];
    setInterventions(updated);
    await saveInterventions(updated);
    showNotif('Intervention supprim√©e');
  };

  const addBeneficiaire = async (interventionId) => {
    const intervention = interventions[interventionId];
    const newBenef = createEmptyEvaluation();
    const updated = {
      ...interventions,
      [interventionId]: {
        ...intervention,
        beneficiaires: [...(intervention.beneficiaires || []), newBenef]
      }
    };
    setInterventions(updated);
    await saveInterventions(updated);
    showNotif('Nouveau b√©n√©ficiaire ajout√© !');
  };

  const deleteBeneficiaire = async (interventionId, benefId) => {
    if (!confirm('Supprimer ce b√©n√©ficiaire et son √©valuation ?')) return;
    const intervention = interventions[interventionId];
    const updated = {
      ...interventions,
      [interventionId]: {
        ...intervention,
        beneficiaires: intervention.beneficiaires.filter(b => b.id !== benefId)
      }
    };
    setInterventions(updated);
    await saveInterventions(updated);
    showNotif('B√©n√©ficiaire supprim√©');
  };

  const updateBeneficiaire = async (interventionId, benefId, evalData) => {
    const intervention = interventions[interventionId];
    const updated = {
      ...interventions,
      [interventionId]: {
        ...intervention,
        beneficiaires: intervention.beneficiaires.map(b => 
          b.id === benefId ? evalData : b
        )
      }
    };
    setInterventions(updated);
    await saveInterventions(updated);
  };

  if (!currentUser) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
          <div className="text-center mb-8">
            <div className="w-20 h-20 bg-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-4xl">üéµ</div>
            <h1 className="text-3xl font-bold text-purple-900 mb-2">Haltes Musicales</h1>
            <p className="text-gray-600">Plateforme Professionnels</p>
          </div>
          
          <div className="space-y-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
              <input
                type="text"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
              />
            </div>

            {loginError && (
              <div className="bg-red-50 text-red-700 px-4 py-3 rounded-lg text-sm">{loginError}</div>
            )}

            <button
              onClick={handleLogin}
              className="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700 transition shadow-lg"
            >
              Se connecter
            </button>
          </div>

          <div className="mt-8 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl">
            <p className="font-semibold text-sm text-center mb-4">Connexion rapide :</p>
            <div className="space-y-2">
              {USERS.map((user) => (
                <button
                  key={user.id}
                  onClick={() => handleQuickLogin(user)}
                  className="w-full px-4 py-3 bg-white hover:bg-purple-50 rounded-lg text-sm font-medium transition flex items-center gap-3"
                >
                  <div className="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold">
                    {user.id.replace('prof', '')}
                  </div>
                  <span>{user.name}</span>
                </button>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }

  const interventionsList = Object.values(interventions).sort((a, b) => 
    new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time)
  );

  return (
    <div className="min-h-screen bg-gray-50">
      {notification && (
        <div className={`fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${
          notification.type === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`}>
          {notification.msg}
        </div>
      )}

      <header className="bg-white shadow-sm border-b sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-4">
            <div className="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center text-white text-2xl">üéµ</div>
            <div>
              <h1 className="text-2xl font-bold text-purple-900">Haltes Musicales</h1>
              <p className="text-sm text-gray-600">{currentUser.name}</p>
            </div>
          </div>
          <button
            onClick={() => {
              setCurrentUser(null);
              setInterventions({});
            }}
            className="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg"
          >
            <LogOut size={20} />
            D√©connexion
          </button>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 py-6">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold">Mes Interventions ({interventionsList.length})</h2>
          <button
            onClick={() => setShowAddModal(true)}
            className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-lg"
          >
            <Plus size={20} />
            Nouvelle intervention
          </button>
        </div>

        <div className="space-y-6">
          {interventionsList.length === 0 ? (
            <div className="bg-white rounded-xl p-12 text-center shadow">
              <div className="text-6xl mb-4">üìÖ</div>
              <h3 className="text-xl font-semibold mb-2">Aucune intervention</h3>
              <p className="text-gray-500 mb-6">Cr√©ez votre premi√®re intervention</p>
              <button
                onClick={() => setShowAddModal(true)}
                className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
              >
                <Plus className="inline mr-2" size={20} />
                Cr√©er une intervention
              </button>
            </div>
          ) : (
            interventionsList.map(intervention => (
              <InterventionCard
                key={intervention.id}
                intervention={intervention}
                onDelete={handleDeleteIntervention}
                onAddBeneficiaire={addBeneficiaire}
                onDeleteBeneficiaire={deleteBeneficiaire}
                onUpdateBeneficiaire={updateBeneficiaire}
              />
            ))
          )}
        </div>
      </div>

      {showAddModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl p-6 w-full max-w-md">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-xl font-bold">Nouvelle intervention</h3>
              <button onClick={() => setShowAddModal(false)} className="text-gray-400 hover:text-gray-600">
                <X size={24} />
              </button>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-2">Date *</label>
                <input
                  type="date"
                  value={newIntervention.date}
                  onChange={(e) => setNewIntervention({...newIntervention, date: e.target.value})}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">Heure *</label>
                <input
                  type="time"
                  value={newIntervention.time}
                  onChange={(e) => setNewIntervention({...newIntervention, time: e.target.value})}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">Lieu *</label>
                <input
                  type="text"
                  value={newIntervention.lieu}
                  onChange={(e) => setNewIntervention({...newIntervention, lieu: e.target.value})}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  placeholder="Ex: Cr√®che Les Lutins"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-2">Notes</label>
                <textarea
                  value={newIntervention.notes}
                  onChange={(e) => setNewIntervention({...newIntervention, notes: e.target.value})}
                  className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none"
                  rows="3"
                />
              </div>
              <div className="flex gap-3 pt-4">
                <button
                  onClick={() => setShowAddModal(false)}
                  className="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50"
                >
                  Annuler
                </button>
                <button
                  onClick={handleAddIntervention}
                  className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                >
                  Cr√©er
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function InterventionCard({ intervention, onDelete, onAddBeneficiaire, onDeleteBeneficiaire, onUpdateBeneficiaire }) {
  const [showBenefs, setShowBenefs] = useState(false);
  const beneficiaires = intervention.beneficiaires || [];

  return (
    <div className="bg-white rounded-xl shadow-sm border">
      <div className="p-6">
        <div className="flex justify-between items-start mb-4">
          <div className="flex-1">
            <div className="flex items-center gap-3 mb-2">
              <span className="text-lg font-semibold text-purple-900">
                {new Date(intervention.date).toLocaleDateString('fr-FR', {
                  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
                })}
              </span>
              <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">
                {intervention.time}
              </span>
            </div>
            <p className="text-gray-700 font-medium">üìç {intervention.lieu}</p>
            {intervention.notes && (
              <p className="text-gray-600 text-sm mt-2 bg-gray-50 p-3 rounded-lg">{intervention.notes}</p>
            )}
          </div>
          <div className="flex gap-2 ml-4">
            <button
              onClick={() => setShowBenefs(!showBenefs)}
              className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition ${
                showBenefs ? 'bg-purple-600 text-white' : 'bg-purple-50 text-purple-600 hover:bg-purple-100'
              }`}
            >
              <Users size={18} />
              B√©n√©ficiaires ({beneficiaires.length})
            </button>
            <button
              onClick={() => onDelete(intervention.id)}
              className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
            >
              <Trash2 size={18} />
            </button>
          </div>
        </div>
      </div>

      {showBenefs && (
        <div className="border-t p-6 bg-gray-50">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-xl font-bold text-purple-900">üë• B√©n√©ficiaires de cette intervention</h3>
            <button
              onClick={() => onAddBeneficiaire(intervention.id)}
              className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              <UserPlus size={18} />
              Ajouter un b√©n√©ficiaire
            </button>
          </div>

          {beneficiaires.length === 0 ? (
            <div className="bg-white rounded-lg p-8 text-center">
              <Users size={48} className="mx-auto text-gray-300 mb-3" />
              <p className="text-gray-500 mb-4">Aucun b√©n√©ficiaire pour cette intervention</p>
              <button
                onClick={() => onAddBeneficiaire(intervention.id)}
                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
              >
                <UserPlus className="inline mr-2" size={18} />
                Ajouter le premier b√©n√©ficiaire
              </button>
            </div>
          ) : (
            <div className="space-y-6">
              {beneficiaires.map((benef) => (
                <BeneficiaireEvaluation
                  key={benef.id}
                  interventionId={intervention.id}
                  benef={benef}
                  onUpdate={onUpdateBeneficiaire}
                  onDelete={onDeleteBeneficiaire}
                />
              ))}
            </div>
          )}
        </div>
      )}
    </div>
  );
}

function BeneficiaireEvaluation({ interventionId, benef, onUpdate, onDelete }) {
  const [showEval, setShowEval] = useState(false);

  const updateBenefInfo = (field, value) => {
    const updated = {
      ...benef,
      beneficiaire: { ...benef.beneficiaire, [field]: value }
    };
    onUpdate(interventionId, benef.id, updated);
  };

  const updateField = (field, value) => {
    const updated = { ...benef, [field]: value };
    onUpdate(interventionId, benef.id, updated);
  };

  const updateScore = (section, itemKey, moment, value) => {
    const updated = {
      ...benef,
      evaluations: {
        ...benef.evaluations,
        [`${section}_${itemKey}_${moment}`]: value
      }
    };
    onUpdate(interventionId, benef.id, updated);
  };

  const updateComment = (section, value) => {
    const updated = {
      ...benef,
      commentaires: {
        ...benef.commentaires,
        [section]: value
      }
    };
    onUpdate(interventionId, benef.id, updated);
  };

  const benefName = benef.beneficiaire.nom && benef.beneficiaire.prenom 
    ? `${benef.beneficiaire.nom} ${benef.beneficiaire.prenom}`
    : 'B√©n√©ficiaire sans nom';

  return (
    <div className="bg-white rounded-lg border-2 border-purple-100">
      <div className="p-4 bg-purple-50 flex justify-between items-center">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold">
            üë§
          </div>
          <div>
            <h4 className="font-bold text-purple-900">{benefName}</h4>
            {benef.beneficiaire.age && (
              <p className="text-sm text-gray-600">{benef.beneficiaire.age} ans - {benef.beneficiaire.sexe}</p>
            )}
          </div>
        </div>
        <div className="flex gap-2">
          <button
            onClick={() => setShowEval(!showEval)}
            className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition ${
              showEval ? 'bg-purple-600 text-white' : 'bg-white text-purple-600 hover:bg-purple-50 border border-purple-200'
            }`}
          >
            <FileText size={16} />
            {showEval ? 'Masquer' : 'Grille'}
          </button>
          <button
            onClick={() => onDelete(interventionId, benef.id)}
            className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
          >
            <Trash2 size={16} />
          </button>
        </div>
      </div>

      {showEval && (
        <div className="p-6">
          {/* Informations b√©n√©ficiaire */}
          <div className="mb-6 p-4 bg-purple-50 rounded-lg">
            <h5 className="font-bold mb-4 text-purple-900">INFORMATIONS B√âN√âFICIAIRE</h5>
            <div className="grid grid-cols-2 gap-3">
              <input
                type="text"
                placeholder="Nom *"
                value={benef.beneficiaire.nom}
                onChange={(e) => updateBenefInfo('nom', e.target.value)}
                className="px-3 py-2 border rounded-lg text-sm"
              />
              <input
                type="text"
                placeholder="Pr√©nom *"
                value={benef.beneficiaire.prenom}
                onChange={(e) => updateBenefInfo('prenom', e.target.value)}
                className="px-3 py-2 border rounded-lg text-sm"
              />
              <input
                type="date"
                value={benef.beneficiaire.dateNaissance}
                onChange={(e) => updateBenefInfo('dateNaissance', e.target.value)}
                className="px-3 py-2 border rounded-lg text-sm"
              />
              <input
                type="number"
                placeholder="√Çge"
                value={benef.beneficiaire.age}
                onChange={(e) => updateBenefInfo('age', e.target.value)}
                className="px-3 py-2 border rounded-lg text-sm"
              />
              <select
                value={benef.beneficiaire.sexe}
                onChange={(e) => updateBenefInfo('sexe', e.target.value)}
                className="px-3 py-2 border rounded-lg text-sm"
              >
                <option>F√©minin</option>
                <option>Masculin</option>
                <option>Autre</option>
              </select>
            </div>
            <div className="mt-3 space-y-2">
              <textarea
                placeholder="Pathologies et/ou syndromes"
                value={benef.pathologies}
                onChange={(e) => updateField('pathologies', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg text-sm"
                rows="2"
              />
              <textarea
                placeholder="Souhaits musicaux"
                value={benef.souhaitsMusicaux}
                onChange={(e) => updateField('souhaitsMusicaux', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg text-sm"
                rows="2"
              />
              <textarea
                placeholder="Objectifs pour l'institution"
                value={benef.objectifs}
                onChange={(e) => updateField('objectifs', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg text-sm"
                rows="2"
              />
            </div>
          </div>

          {/* √âchelle */}
          <div className="mb-4 p-3 bg-blue-50 rounded-lg">
            <p className="font-semibold text-sm mb-1">√âchelle : </p>
            <div className="flex gap-2 text-xs flex-wrap">
              <span>0:Inexistant</span>
              <span>1:Tr√®s faible</span>
              <span>2:Faible</span>
              <span>3:Mod√©r√©</span>
              <span>4:√âlev√©</span>
              <span>5:Tr√®s √©lev√©</span>
            </div>
          </div>

          {/* Sections d'√©valuation */}
          <div className="space-y-4">
            {Object.entries(EVALUATION_STRUCTURE).map(([sectionKey, section]) => (
              <div key={sectionKey} className="border rounded-lg p-4 bg-gray-50">
                <h5 className="font-bold text-sm mb-3 text-purple-900">{section.title}</h5>
                
                {section.items.map((item) => (
                  <div key={item.key} className="mb-3 p-3 bg-white rounded-lg">
                    <p className="font-medium text-xs mb-2">{item.label}</p>
                    <div className="flex gap-1 flex-wrap">
                      {item.moments.map(moment => (
                        <div key={moment} className="flex-1 min-w-[70px]">
                          <label className="block text-xs text-gray-600 mb-1">{MOMENT_LABELS[moment]}</label>
                          <select
                            value={benef.evaluations[`${sectionKey}_${item.key}_${moment}`] || ''}
                            onChange={(e) => updateScore(sectionKey, item.key, moment, e.target.value)}
                            className="w-full px-1 py-1 border rounded text-center text-xs"
                          >
                            <option value="">-</option>
                            {[0,1,2,3,4,5].map(v => <option key={v} value={v}>{v}</option>)}
                          </select>
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
                
                <textarea
                  placeholder="Commentaires / Observations"
                  value={benef.commentaires[sectionKey] || ''}
                  onChange={(e) => updateComment(sectionKey, e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg text-sm mt-2"
                  rows="2"
                />
              </div>
            ))}
          </div>

          {/* Comptes-rendus */}
          <div className="mt-4 space-y-3">
            <div className="border rounded-lg p-4 bg-white">
              <label className="block font-medium text-sm mb-2">Compte-rendu HM (Psychologue)</label>
              <textarea
                value={benef.compteRenduHM}
                onChange={(e) => updateField('compteRenduHM', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg text-sm"
                rows="3"
              />
            </div>
            <div className="border rounded-lg p-4 bg-white">
              <label className="block font-medium text-sm mb-2">Compte-rendu √âtablissement (Psychologue)</label>
              <textarea
                value={benef.compteRenduEtablissement}
                onChange={(e) => updateField('compteRenduEtablissement', e.target.value)}
                className="w-full px-3 py-2 border rounded-lg text-sm"
                rows="3"
              />
            </div>
          </div>

          <div className="mt-4 p-3 bg-green-50 rounded-lg text-center text-sm text-green-700">
            ‚úì Toutes les modifications sont sauvegard√©es automatiquement
          </div>
        </div>
      )}
    </div>
  );
}
