<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haltes Musicales</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="app"></div>

  <script>
    // Configuration
    const ADMIN_CODE = 'ADMIN2024';
    
    // State global
    let state = {
      currentUser: null,
      users: { professionnels: [], invites: [] },
      interventions: {},
      showSignup: true,
      showAdminLogin: false,
      showAdminPanel: false,
      showAddModal: false,
      showRgpdModal: false,
      expandedIntervention: null,
      isLoading: true,
      notification: null,
      loginData: { email: '', password: '' },
      loginError: '',
      signupData: { name: '', email: '', password: '', type: 'professionnel', etablissement: '', rgpdConsent: false },
      newIntervention: { date: '', time: '', lieu: '' },
      newUser: { name: '', email: '', password: '', type: 'professionnel' }
    };

    // Ic√¥nes SVG
    const icons = {
      calendar: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
      logout: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>`,
      plus: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
      lock: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
      users: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
      trash: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`
    };

    // Utilitaires
    function showNotif(msg, type = 'success') {
      state.notification = { msg, type };
      render();
      setTimeout(() => {
        state.notification = null;
        render();
      }, 3000);
    }

    function loadData() {
      state.isLoading = true;
      try {
        const usersData = localStorage.getItem('haltes_users');
        if (usersData) {
          state.users = JSON.parse(usersData);
        }
      } catch (e) {
        console.log('Premi√®re utilisation', e);
      }
      state.isLoading = false;
      render();
    }

    function loadUserInterventions() {
      if (!state.currentUser || state.currentUser.type === 'admin') return;
      try {
        const data = localStorage.getItem(`interventions_${state.currentUser.id}`);
        if (data) {
          state.interventions = JSON.parse(data);
        } else {
          state.interventions = {};
        }
      } catch (e) {
        console.log('Erreur chargement interventions', e);
        state.interventions = {};
      }
      render();
    }

    function saveInterventions(data) {
      if (!state.currentUser || state.currentUser.type === 'admin') return;
      try {
        localStorage.setItem(`interventions_${state.currentUser.id}`, JSON.stringify(data));
      } catch (e) { 
        console.error('Erreur sauvegarde', e);
        showNotif('Erreur sauvegarde', 'error');
      }
    }

    function saveUsers(userData) {
      try {
        localStorage.setItem('haltes_users', JSON.stringify(userData));
        state.users = userData;
      } catch (e) {
        console.error('Erreur sauvegarde users', e);
        showNotif('Erreur sauvegarde', 'error');
      }
    }

    // Handlers
    function handleLogin() {
      if (state.loginData.email.trim() === 'admin' && state.loginData.password.trim() === ADMIN_CODE) {
        state.currentUser = { type: 'admin', name: 'Administrateur', id: 'admin' };
        showNotif('Bienvenue Administrateur !');
        state.showAdminPanel = true;
        state.showAdminLogin = false;
        render();
        return;
      }
      const allUsers = [...state.users.professionnels, ...state.users.invites];
      const user = allUsers.find(u => u.email === state.loginData.email.trim() && u.password === state.loginData.password.trim());
      if (user) { 
        state.currentUser = user; 
        showNotif(`Bienvenue ${user.name} !`); 
        state.showSignup = false;
        loadUserInterventions();
      } else { 
        state.loginError = 'Email ou mot de passe incorrect';
        render();
      }
    }

    function handleSignup() {
      if (!state.signupData.name || !state.signupData.password || !state.signupData.email) {
        showNotif('Remplissez tous les champs obligatoires', 'error');
        return;
      }
      if (state.signupData.password.length < 8) {
        showNotif('Le mot de passe doit contenir au moins 8 caract√®res', 'error');
        return;
      }
      if (!state.signupData.rgpdConsent) {
        showNotif('Vous devez accepter la politique de confidentialit√©', 'error');
        return;
      }
      const allUsers = [...state.users.professionnels, ...state.users.invites];
      if (allUsers.find(u => u.email === state.signupData.email)) {
        showNotif('Cet email existe d√©j√†', 'error');
        return;
      }
      const userData = { ...state.users };
      const id = Date.now().toString();
      const userToAdd = { 
        name: state.signupData.name, 
        email: state.signupData.email,
        password: state.signupData.password, 
        type: state.signupData.type, 
        id,
        etablissement: state.signupData.etablissement || '',
        createdAt: new Date().toISOString(),
        rgpdConsent: true
      };
      if (state.signupData.type === 'professionnel') {
        userData.professionnels.push(userToAdd);
      } else {
        userData.invites.push(userToAdd);
      }
      saveUsers(userData);
      state.currentUser = userToAdd;
      showNotif('Compte cr√©√© avec succ√®s !');
      state.showSignup = false;
      loadUserInterventions();
    }

    function handleAddUser() {
      if (!state.newUser.name || !state.newUser.password || !state.newUser.email) {
        showNotif('Remplissez tous les champs', 'error');
        return;
      }
      const allUsers = [...state.users.professionnels, ...state.users.invites];
      if (allUsers.find(u => u.email === state.newUser.email)) {
        showNotif('Cet email existe d√©j√†', 'error');
        return;
      }
      const userData = { ...state.users };
      const id = Date.now().toString();
      const userToAdd = { 
        ...state.newUser, 
        id,
        createdAt: new Date().toISOString(),
        rgpdConsent: true
      };
      if (state.newUser.type === 'professionnel') {
        userData.professionnels.push(userToAdd);
      } else {
        userData.invites.push(userToAdd);
      }
      saveUsers(userData);
      state.newUser = { name: '', email: '', password: '', type: 'professionnel' };
      showNotif('Utilisateur ajout√© !');
      render();
    }

    function handleDeleteUser(userId, type) {
      const userData = { ...state.users };
      if (type === 'professionnel') {
        userData.professionnels = userData.professionnels.filter(u => u.id !== userId);
      } else {
        userData.invites = userData.invites.filter(u => u.id !== userId);
      }
      saveUsers(userData);
      showNotif('Utilisateur supprim√©');
      render();
    }

    function handleAddIntervention() {
      if (!state.newIntervention.date || !state.newIntervention.time || !state.newIntervention.lieu) {
        showNotif('Remplissez tous les champs', 'error');
        return;
      }
      const id = Date.now().toString();
      const updated = { 
        ...state.interventions, 
        [id]: { 
          ...state.newIntervention, 
          id, 
          beneficiaires: [],
          createdBy: state.currentUser.id,
          createdByName: state.currentUser.name,
          createdByType: state.currentUser.type,
          etablissement: state.currentUser.etablissement || ''
        }
      };
      state.interventions = updated;
      saveInterventions(updated);
      state.showAddModal = false;
      state.newIntervention = { date: '', time: '', lieu: '' };
      showNotif('Intervention cr√©√©e !');
      render();
    }

    function createEmptyEvaluation() {
      return {
        id: Date.now().toString() + Math.random(),
        beneficiaire: { nom: '', prenom: '', dateNaissance: '', sexe: 'F√©minin' },
        pathologies: '', 
        souhaitsMusicaux: '',
        objectifs: '',
        compteRenduMut: '',
        compteRenduEtablissement: '',
        dates: [
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 1' },
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 2' },
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 3' },
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 4' }
        ]
      };
    }

    function handleAddBeneficiaire(interventionId) {
      const newBenef = createEmptyEvaluation();
      const updated = { ...state.interventions };
      if (!updated[interventionId].beneficiaires) updated[interventionId].beneficiaires = [];
      updated[interventionId].beneficiaires.push(newBenef);
      state.interventions = updated;
      saveInterventions(updated);
      showNotif('B√©n√©ficiaire ajout√© !');
      render();
    }

    function getAccessibleInterventions() {
      const allInterventions = Object.values(state.interventions);
      if (state.currentUser.type === 'professionnel') {
        return allInterventions.filter(intervention => intervention.createdBy === state.currentUser.id);
      } else if (state.currentUser.type === 'invite') {
        return allInterventions.filter(intervention => 
          intervention.createdBy === state.currentUser.id || 
          intervention.etablissement === state.currentUser.etablissement
        );
      }
      return [];
    }

    // Templates
    function renderLoading() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center">
          <div class="text-center">
            <div class="text-6xl mb-4">üéµ</div>
            <p class="text-gray-600">Chargement...</p>
          </div>
        </div>
      `;
    }

    function renderAdminLogin() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
              <span class="text-6xl">üîê</span>
              <h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Administration</h1>
              <p class="text-gray-600">Acc√®s r√©serv√©</p>
            </div>
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email administrateur</label>
                <input type="text" id="admin-email" value="${state.loginData.email}" class="w-full px-4 py-3 border rounded-lg" placeholder="admin">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                <input type="password" id="admin-password" value="${state.loginData.password}" class="w-full px-4 py-3 border rounded-lg" placeholder="Mot de passe">
              </div>
              ${state.loginError ? `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>` : ''}
              <button onclick="handleAdminLoginClick()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Se connecter</button>
              <button onclick="backToSignup()" class="w-full text-gray-600 hover:text-gray-800 text-sm">‚Üê Retour</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderSignup() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
              <span class="text-6xl">üéµ</span>
              <h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Haltes Musicales</h1>
              <p class="text-gray-600">Cr√©er votre compte</p>
            </div>
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Nom complet *</label>
                <input type="text" id="signup-name" value="${state.signupData.name}" class="w-full px-4 py-3 border rounded-lg" placeholder="Dr. Marie Dupont">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                <input type="email" id="signup-email" value="${state.signupData.email}" class="w-full px-4 py-3 border rounded-lg" placeholder="email@exemple.fr">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe * (min. 8 car.)</label>
                <input type="password" id="signup-password" value="${state.signupData.password}" class="w-full px-4 py-3 border rounded-lg" placeholder="********" minlength="8">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Type *</label>
                <select id="signup-type" class="w-full px-4 py-3 border rounded-lg">
                  <option value="professionnel" ${state.signupData.type === 'professionnel' ? 'selected' : ''}>Psychologue</option>
                  <option value="invite" ${state.signupData.type === 'invite' ? 'selected' : ''}>√âtablissement</option>
                </select>
              </div>
              <div id="etablissement-field" class="${state.signupData.type === 'invite' ? '' : 'hidden'}">
                <label class="block text-sm font-medium text-gray-700 mb-2">√âtablissement</label>
                <input type="text" id="signup-etablissement" value="${state.signupData.etablissement}" class="w-full px-4 py-3 border rounded-lg" placeholder="EHPAD Les Jardins">
              </div>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <label class="flex items-start gap-3 text-sm">
                  <input type="checkbox" id="signup-rgpd" ${state.signupData.rgpdConsent ? 'checked' : ''} class="mt-1">
                  <span>J'accepte la <button onclick="showRgpd()" class="text-purple-600 underline" type="button">politique de confidentialit√©</button> *</span>
                </label>
              </div>
              <button onclick="handleSignupClick()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Cr√©er mon compte</button>
              <button onclick="switchToLogin()" class="w-full text-purple-600 hover:text-purple-700 text-sm font-medium">J'ai d√©j√† un compte</button>
              <button onclick="showAdminLoginPage()" class="w-full text-gray-400 hover:text-gray-600 text-xs pt-4 border-t">Acc√®s admin</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderLogin() {
      return `
        <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
              <span class="text-6xl">üéµ</span>
              <h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Haltes Musicales</h1>
              <p class="text-gray-600">Connexion</p>
            </div>
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="login-email" value="${state.loginData.email}" class="w-full px-4 py-3 border rounded-lg" placeholder="email@exemple.fr">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                <input type="password" id="login-password" value="${state.loginData.password}" class="w-full px-4 py-3 border rounded-lg" placeholder="********">
              </div>
              ${state.loginError ? `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>` : ''}
              <button onclick="handleLoginClick()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Se connecter</button>
              <button onclick="switchToSignup()" class="w-full text-purple-600 hover:text-purple-700 text-sm font-medium">Cr√©er un compte</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderAdminPanel() {
      return `
        <div class="min-h-screen bg-gray-50">
          ${state.notification ? `
            <div class="fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg ${state.notification.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
              ${state.notification.type === 'success' ? '<span>‚úì</span>' : ''}
              <span>${state.notification.msg}</span>
            </div>
          ` : ''}
          <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
              <div class="flex items-center gap-4">
                <span class="text-4xl">üéµ</span>
                <div>
                  <h1 class="text-2xl font-bold text-purple-900">Administration</h1>
                  <p class="text-sm text-gray-600">Gestion des utilisateurs</p>
                </div>
              </div>
              <button onclick="logout()" class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                ${icons.logout}
                D√©connexion
              </button>
            </div>
          </header>
          <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="bg-white rounded-xl shadow p-6 mb-6">
              <h2 class="text-xl font-bold text-gray-900 mb-4">Ajouter un utilisateur</h2>
              <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <input type="text" id="new-user-name" placeholder="Nom" class="px-4 py-2 border rounded-lg" value="${state.newUser.name}">
                <input type="email" id="new-user-email" placeholder="Email" class="px-4 py-2 border rounded-lg" value="${state.newUser.email}">
                <input type="password" id="new-user-password" placeholder="Mot de passe" class="px-4 py-2 border rounded-lg" value="${state.newUser.password}">
                <select id="new-user-type" class="px-4 py-2 border rounded-lg">
                  <option value="professionnel">Psychologue</option>
                  <option value="invite">√âtablissement</option>
                </select>
                <button onclick="handleAddUserClick()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center justify-center gap-2">
                  ${icons.plus}
                  Ajouter
                </button>
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
              <div class="bg-white rounded-xl shadow p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">Psychologues (${state.users.professionnels.length})</h3>
                <div class="space-y-3">
                  ${state.users.professionnels.map(user => `
                    <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                      <div>
                        <p class="font-medium text-gray-900">${user.name}</p>
                        <p class="text-sm text-gray-600">${user.email}</p>
                      </div>
                      <button onclick="handleDeleteUser('${user.id}', 'professionnel')" class="text-red-600 hover:text-red-700">
                        ${icons.trash}
                      </button>
                    </div>
                  `).join('')}
                </div>
              </div>
              <div class="bg-white rounded-xl shadow p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4">√âtablissements (${state.users.invites.length})</h3>
                <div class="space-y-3">
                  ${state.users.invites.map(user => `
                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                      <div>
                        <p class="font-medium text-gray-900">${user.name}</p>
                        <p class="text-sm text-gray-600">${user.email}</p>
                        ${user.etablissement ? `<p class="text-xs text-gray-500">${user.etablissement}</p>` : ''}
                      </div>
                      <button onclick="handleDeleteUser('${user.id}', 'invite')" class="text-red-600 hover:text-red-700">
                        ${icons.trash}
                      </button>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderUserDashboard() {
      const interventionsList = getAccessibleInterventions().sort((a, b) => 
        new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time)
      );

      if (state.expandedIntervention) {
        const intervention = state.interventions[state.expandedIntervention];
        return `
          <div class="min-h-screen bg-gray-50">
            ${state.notification ? `
              <div class="fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 ${state.notification.type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}">
                ${state.notification.type === 'success' ? '<span>‚úì</span>' : ''}
                <span>${state.notification.msg}</span>
              </div>
            ` : ''}
            <header class="bg-white shadow-sm border-b sticky top-0 z-40">
              <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="backToInterventions()" class="flex items-center gap-4 hover:opacity-80">
                  <span class="text-4xl">üéµ</span>
                  <div>
                    <h1 class="text-2xl font-bold text-purple-900">Haltes Musicales</h1>
                    <p class="text-sm text-gray-600 flex items-center gap-2">
                      ${state.currentUser.type === 'professionnel' ? icons.users : icons.lock}
                      ${state.currentUser.name}
                    </p>
                  </div>
                </button>
                <button onclick="logout()" class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">
                  ${icons.logout}
                  <span class="hidden sm:inline">D√©connexion</span>
                </button>
              </div>
            </header>
            <div class="max-w-7xl mx-auto px-4 py-6">
              <button onclick="backToInterventions()" class="mb-4 text-purple-600 hover:text-purple-700 font-medium">
                ‚Üê Retour aux interventions
              </button>
              <div class="bg-white rounded-xl shadow p-6 mb-6">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h2 class="text-2xl font-bold text-gray-900">${intervention.lieu}</h2>
                    <p class="text-gray-600 mt-1">
                      ${new Date(intervention.date).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} √† ${intervention.time}
                    </p>
                  </div>
                  ${state.currentUser.type === 'professionnel' ? `
                    <button onclick="handleAddBeneficiaire('${intervention.id}')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                      ${icons.plus}
                      Ajouter b√©n√©ficiaire
                    </button>
                  ` : ''}
                </div>
              </div>
              ${!intervention.beneficiaires || intervention.beneficiaires.length === 0 ? `
                <div class="bg-white rounded-xl p-12 text-center shadow">
