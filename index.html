<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Haltes Musicales</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50">
    <div id="app"></div>

    <script>
      const ADMIN_CODE = "ADMIN2024";

      const EVALUATION_STRUCTURE = {
        interactionsSociales: {
          title: "INTERACTIONS SOCIALES",
          items: [
            {
              key: "attitudeHabituelle",
              label: "Attitude habituelle",
              moments: [1, 2, 3, 4],
              type: "invite",
              fieldType: "text",
            },
            {
              key: "interaction",
              label:
                "Interaction Sociale (√©changes avec les personnes pr√©sentes)",
              moments: [1, 2, 3, 4],
              type: "yellow",
            },
            {
              key: "reactionEmotionnelle",
              label: "R√©action √©motionnelle",
              moments: [1, 2, 3, 4],
              type: "yellow",
            },
            {
              key: "reactionSuiteHalte",
              label: "R√©action suite √† la halte",
              moments: [1, 2, 3, 4],
              type: "invite",
              fieldType: "text",
            },
          ],
        },
        stimulationSensorielle: {
          title: "STIMULATION MULTISENSORIELLE",
          items: [
            {
              key: "attitudeHabituelle",
              label: "Attitude habituelle",
              moments: [1, 2, 3, 4],
              type: "invite",
              fieldType: "text",
            },
            {
              key: "reactionAuditive",
              label: "R√©action auditive (r√©ceptivit√© √† la musique)",
              moments: [1, 2, 3, 4],
              type: "yellow",
            },
            {
              key: "reactionVisuelle",
              label: "R√©action visuelle (r√©ceptivit√© aux √©l√©ments visuels)",
              moments: [1, 2, 3, 4],
              type: "yellow",
            },
            {
              key: "reactionKinesth",
              label: "R√©action kinesth√©sique (mouvement, danse)",
              moments: [1, 2, 3, 4],
              type: "yellow",
            },
            {
              key: "reactionSuiteHalte",
              label: "R√©action suite √† la halte",
              moments: [1, 2, 3, 4],
              type: "invite",
              fieldType: "text",
            },
          ],
        },
        memoire: {
          title: "M√âMOIRE / SOUVENIRS",
          items: [
            {
              key: "attitudeHabituelle",
              label: "Attitude habituelle",
              moments: [1, 2, 3, 4],
              type: "invite",
              fieldType: "text",
            },
            {
              key: "reactivationSouvenirs",
              label: "R√©activation et verbalisation de souvenirs",
              moments: [1, 2, 3, 4],
              type: "yellow",
            },
            {
              key: "reconnaissanceMusique",
              label: "Reconnaissance de la musique",
              moments: [1, 2, 3, 4],
              type: "yellow",
            },
            {
              key: "reactionEmotionnelle2",
              label: "R√©action √©motionnelle",
              moments: [1, 2, 3, 4],
              type: "yellow",
            },
            {
              key: "reactionSuiteHalte",
              label: "R√©action suite √† la halte",
              moments: [1, 2, 3, 4],
              type: "invite",
              fieldType: "text",
            },
          ],
        },
        comportements: {
          title: "COMPORTEMENTS",
          items: [
            {
              key: "ideesDelirantes",
              label: "Id√©es d√©lirantes",
              moments: [1, 2, 3, 4],
              type: "white",
            },
            {
              key: "hallucinations",
              label: "Hallucinations",
              moments: [1, 2, 3, 4],
              type: "white",
            },
            {
              key: "agitation",
              label: "Agitation/Agressivit√©",
              moments: [1, 2, 3, 4],
              type: "white",
            },
            {
              key: "depression",
              label: "D√©pression/Dysphorie",
              moments: [1, 2, 3, 4],
              type: "white",
            },
            {
              key: "anxiete",
              label: "Anxi√©t√©",
              moments: [1, 2, 3, 4],
              type: "white",
            },
            {
              key: "euphorie",
              label: "Exaltation de l'humeur / Euphorie",
              moments: [1, 2, 3, 4],
              type: "white",
            },
            {
              key: "apathie",
              label: "Apathie / Indiff√©rence",
              moments: [1, 2, 3, 4],
              type: "white",
            },
            {
              key: "desinhibition",
              label: "D√©sinhibition",
              moments: [1, 2, 3, 4],
              type: "white",
            },
            {
              key: "irritabilite",
              label: "Irritabilit√© / Instabilit√© de l'humeur",
              moments: [1, 2, 3, 4],
              type: "white",
            },
            {
              key: "moteurAberrant",
              label: "Comportement moteur aberrant",
              moments: [1, 2, 3, 4],
              type: "white",
            },
          ],
        },
      };

      let state = {
        currentUser: null,
        users: { professionnels: [], invites: [] },
        interventions: {},
        view: "signup",
        loginData: { email: "", password: "" },
        signupData: {
          name: "",
          email: "",
          password: "",
          type: "professionnel",
          etablissement: "",
          rgpdConsent: false,
        },
        loginError: "",
        newIntervention: { date: "", time: "", lieu: "" },
        expandedIntervention: null,
        selectedBeneficiaire: null,
        inviteToken: null,
      };

      function init() {
        try {
          const usersData = localStorage.getItem("haltes_users");
          if (usersData) state.users = JSON.parse(usersData);
        } catch (e) {}
        
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        if (token) {
          state.inviteToken = token;
          state.view = "invite-login";
        }
        
        render();
      }

      function showNotif(msg, type = "success") {
        const notif = document.createElement("div");
        notif.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${
          type === "success" ? "bg-green-500" : "bg-red-500"
        }`;
        notif.textContent = msg;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
      }

      function canEdit(fieldType) {
        if (!state.currentUser) return false;
        if (fieldType === "comment") return true;
        if (fieldType === "yellow") return true;
        if (fieldType === "white")
          return state.currentUser.type === "professionnel";
        if (fieldType === "invite") return state.currentUser.type === "invite";
        return false;
      }

      function createEmptyEvaluation() {
        return {
          id: Date.now().toString() + Math.random(),
          beneficiaire: {
            nom: "",
            prenom: "",
            dateNaissance: "",
            sexe: "F√©minin",
          },
          pathologies: "",
          souhaitsMusicaux: "",
          objectifs: "",
          compteRenduMut: "",
          compteRenduEtablissement: "",
          dates: [
            {
              date: "",
              evaluations: {},
              commentaires: {},
              label: "Intervention 1",
            },
            {
              date: "",
              evaluations: {},
              commentaires: {},
              label: "Intervention 2",
            },
            {
              date: "",
              evaluations: {},
              commentaires: {},
              label: "Intervention 3",
            },
            {
              date: "",
              evaluations: {},
              commentaires: {},
              label: "Intervention 4",
            },
          ],
        };
      }

      function saveInterventions() {
        if (!state.currentUser || state.currentUser.type === "admin") return;
        try {
          localStorage.setItem(
            `interventions_${state.currentUser.id}`,
            JSON.stringify(state.interventions)
          );
        } catch (e) {
          console.error("Erreur sauvegarde", e);
        }
      }

      function updateBeneficiaire(interventionId, benefIndex, field, value) {
        const benef =
          state.interventions[interventionId].beneficiaires[benefIndex];
        if (field.includes(".")) {
          const [parent, child] = field.split(".");
          benef[parent][child] = value;
        } else {
          benef[field] = value;
        }
        saveInterventions();
      }

      function updateEvaluation(
        interventionId,
        benefIndex,
        dateIndex,
        category,
        itemKey,
        moment,
        value
      ) {
        const benef =
          state.interventions[interventionId].beneficiaires[benefIndex];
        if (!benef.dates[dateIndex].evaluations[category]) {
          benef.dates[dateIndex].evaluations[category] = {};
        }
        if (!benef.dates[dateIndex].evaluations[category][itemKey]) {
          benef.dates[dateIndex].evaluations[category][itemKey] = {};
        }
        benef.dates[dateIndex].evaluations[category][itemKey][moment] = value;
        saveInterventions();
      }

      function updateComment(
        interventionId,
        benefIndex,
        dateIndex,
        category,
        itemKey,
        value
      ) {
        const benef =
          state.interventions[interventionId].beneficiaires[benefIndex];
        if (!benef.dates[dateIndex].commentaires[category]) {
          benef.dates[dateIndex].commentaires[category] = {};
        }
        benef.dates[dateIndex].commentaires[category][itemKey] = value;
        saveInterventions();
      }

      function render() {
        const app = document.getElementById("app");

        if (!state.currentUser) {
          if (state.view === "invite-login") {
            app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4">
              <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                  <span class="text-6xl">üéµ</span>
                  <h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Haltes Musicales</h1>
                  <p class="text-gray-600">Acc√®s √âtablissement</p>
                </div>
                <div class="space-y-6">
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-blue-900">Vous avez √©t√© invit√© √† consulter une intervention. Veuillez vous connecter ou cr√©er un compte.</p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-3 border rounded-lg" placeholder="email@exemple.fr">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg" placeholder="********">
                  </div>
                  ${state.loginError ? `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>` : ""}
                  <button onclick="handleInviteLogin()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Se connecter</button>
                  <button onclick="switchView('signup')" class="w-full text-purple-600 hover:text-purple-700 text-sm font-medium">Cr√©er un compte √©tablissement</button>
                </div>
              </div>
            </div>
          `;
          } else if (state.view === "signup") {
            app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4">
              <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                  <span class="text-6xl">üéµ</span>
                  <h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Haltes Musicales</h1>
                  <p class="text-gray-600">Cr√©er votre compte</p>
                </div>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom complet *</label>
                    <input type="text" id="name" class="w-full px-4 py-3 border rounded-lg" placeholder="Dr. Marie Dupont">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="email" class="w-full px-4 py-3 border rounded-lg" placeholder="email@exemple.fr">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe * (min. 8 car.)</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg" placeholder="********">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type *</label>
                    <select id="type" class="w-full px-4 py-3 border rounded-lg">
                      <option value="professionnel">Psychologue Haltes Musicales</option>
                      <option value="invite">√âtablissement (invit√©)</option>
                    </select>
                  </div>
                  <div id="etablissement-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">√âtablissement</label>
                    <input type="text" id="etablissement" class="w-full px-4 py-3 border rounded-lg" placeholder="EHPAD Les Jardins">
                  </div>
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <label class="flex items-start gap-3 text-sm">
                      <input type="checkbox" id="rgpd" class="mt-1">
                      <span>J'accepte la politique de confidentialit√© *</span>
                    </label>
                  </div>
                  ${
                    state.loginError
                      ? `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>`
                      : ""
                  }
                  <button onclick="handleSignup()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Cr√©er mon compte</button>
                  <button onclick="switchView('login')" class="w-full text-purple-600 hover:text-purple-700 text-sm font-medium">J'ai d√©j√† un compte</button>
                  <button onclick="switchView('admin')" class="w-full text-gray-400 hover:text-gray-600 text-xs pt-4 border-t">Acc√®s admin</button>
                </div>
              </div>
            </div>
          `;
            document.getElementById("type").addEventListener("change", (e) => {
              document
                .getElementById("etablissement-field")
                .classList.toggle("hidden", e.target.value !== "invite");
            });
          } else if (state.view === "login") {
            app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4">
              <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                  <span class="text-6xl">üéµ</span>
                  <h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Haltes Musicales</h1>
                  <p class="text-gray-600">Connexion</p>
                </div>
                <div class="space-y-6">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-3 border rounded-lg" placeholder="email@exemple.fr">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg" placeholder="********">
                  </div>
                  ${
                    state.loginError
                      ? `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>`
                      : ""
                  }
                  <button onclick="handleLogin()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Se connecter</button>
                  <button onclick="switchView('signup')" class="w-full text-purple-600 hover:text-purple-700 text-sm font-medium">Cr√©er un compte</button>
                </div>
              </div>
            </div>
          `;
          } else if (state.view === "admin") {
            app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4">
              <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                  <span class="text-6xl">üîí</span>
                  <h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Administration</h1>
                  <p class="text-gray-600">Acc√®s r√©serv√©</p>
                </div>
                <div class="space-y-6">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email administrateur</label>
                    <input type="text" id="email" class="w-full px-4 py-3 border rounded-lg" placeholder="admin">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg" placeholder="Mot de passe">
                  </div>
                  ${
                    state.loginError
                      ? `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>`
                      : ""
                  }
                  <button onclick="handleLogin()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Se connecter</button>
                  <button onclick="switchView('signup')" class="w-full text-gray-600 hover:text-gray-800 text-sm">‚Üê Retour</button>
                </div>
              </div>
            </div>
          `;
          }
          return;
        }

        if (state.currentUser.type === "admin") {
          app.innerHTML = `
          <div class="min-h-screen bg-gray-50">
            <header class="bg-white shadow-sm border-b sticky top-0 z-40">
              <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <span class="text-4xl">üéµ</span>
                  <div>
                    <h1 class="text-2xl font-bold text-purple-900">Administration</h1>
                    <p class="text-sm text-gray-600">Gestion des utilisateurs</p>
                  </div>
                </div>
                <button onclick="logout()" class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">D√©connexion</button>
              </div>
            </header>
            <div class="max-w-7xl mx-auto px-4 py-6">
              <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow p-6">
                  <h3 class="text-lg font-bold text-gray-900 mb-4">Psychologues (${
                    state.users.professionnels.length
                  })</h3>
                  <div class="space-y-3">
                    ${
                      state.users.professionnels
                        .map(
                          (u) => `
                      <div class="p-3 bg-purple-50 rounded-lg">
                        <p class="font-medium text-gray-900">${u.name}</p>
                        <p class="text-sm text-gray-600">${u.email}</p>
                      </div>
                    `
                        )
                        .join("") ||
                      '<p class="text-gray-400 text-sm">Aucun psychologue</p>'
                    }
                  </div>
                </div>
                <div class="bg-white rounded-xl shadow p-6">
                  <h3 class="text-lg font-bold text-gray-900 mb-4">√âtablissements (${
                    state.users.invites.length
                  })</h3>
                  <div class="space-y-3">
                    ${
                      state.users.invites
                        .map(
                          (u) => `
                      <div class="p-3 bg-blue-50 rounded-lg">
                        <p class="font-medium text-gray-900">${u.name}</p>
                        <p class="text-sm text-gray-600">${u.email}</p>
                        ${
                          u.etablissement
                            ? `<p class="text-xs text-gray-500">${u.etablissement}</p>`
                            : ""
                        }
                      </div>
                    `
                        )
                        .join("") ||
                      '<p class="text-gray-400 text-sm">Aucun √©tablissement</p>'
                    }
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
          return;
        }

        const interventionsList = Object.values(state.interventions)
          .filter((i) => i.createdBy === state.currentUser.id)
          .sort((a, b) => new Date(b.date) - new Date(a.date));

        if (state.expandedIntervention && state.selectedBeneficiaire !== null) {
          const intervention = state.interventions[state.expandedIntervention];
          const benef = intervention.beneficiaires[state.selectedBeneficiaire];

          app.innerHTML = `
          <div class="min-h-screen bg-gray-50">
            <header class="bg-white shadow-sm border-b sticky top-0 z-40">
              <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="backToBeneficiaires()" class="flex items-center gap-4 hover:opacity-80">
                  <span class="text-4xl">üéµ</span>
                  <div>
                    <h1 class="text-2xl font-bold text-purple-900">Haltes Musicales</h1>
                    <p class="text-sm text-gray-600">${
                      benef.beneficiaire.nom
                    } ${benef.beneficiaire.prenom}</p>
                  </div>
                </button>
                <button onclick="logout()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">D√©connexion</button>
              </div>
            </header>
            <div class="max-w-7xl mx-auto px-4 py-6">
              <button onclick="backToBeneficiaires()" class="mb-4 text-purple-600 hover:text-purple-700 font-medium">‚Üê Retour aux b√©n√©ficiaires</button>
              
              <div class="bg-white rounded-xl shadow p-6 mb-6">
                <h4 class="text-lg font-bold text-gray-900 mb-4">Informations du b√©n√©ficiaire</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <input type="text" placeholder="Nom" value="${
                    benef.beneficiaire.nom
                  }" onchange="updateBeneficiaire('${intervention.id}', ${
            state.selectedBeneficiaire
          }, 'beneficiaire.nom', this.value)" ${
            !canEdit("white") ? "disabled" : ""
          } class="px-3 py-2 border rounded-lg ${
            !canEdit("white") ? "bg-gray-100" : ""
          }">
                  <input type="text" placeholder="Pr√©nom" value="${
                    benef.beneficiaire.prenom
                  }" onchange="updateBeneficiaire('${intervention.id}', ${
            state.selectedBeneficiaire
          }, 'beneficiaire.prenom', this.value)" ${
            !canEdit("white") ? "disabled" : ""
          } class="px-3 py-2 border rounded-lg ${
            !canEdit("white") ? "bg-gray-100" : ""
          }">
                  <input type="date" value="${
                    benef.beneficiaire.dateNaissance
                  }" onchange="updateBeneficiaire('${intervention.id}', ${
            state.selectedBeneficiaire
          }, 'beneficiaire.dateNaissance', this.value)" ${
            !canEdit("white") ? "disabled" : ""
          } class="px-3 py-2 border rounded-lg ${
            !canEdit("white") ? "bg-gray-100" : ""
          }">
                  <select onchange="updateBeneficiaire('${intervention.id}', ${
            state.selectedBeneficiaire
          }, 'beneficiaire.sexe', this.value)" ${
            !canEdit("white") ? "disabled" : ""
          } class="px-3 py-2 border rounded-lg ${
            !canEdit("white") ? "bg-gray-100" : ""
          }">
                    <option ${
                      benef.beneficiaire.sexe === "F√©minin" ? "selected" : ""
                    }>F√©minin</option>
                    <option ${
                      benef.beneficiaire.sexe === "Masculin" ? "selected" : ""
                    }>Masculin</option>
                  </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                  <textarea placeholder="Pathologies" onchange="updateBeneficiaire('${
                    intervention.id
                  }', ${
            state.selectedBeneficiaire
          }, 'pathologies', this.value)" ${
            !canEdit("white") ? "disabled" : ""
          } class="px-3 py-2 border rounded-lg ${
            !canEdit("white") ? "bg-gray-100" : ""
          }" rows="2">${benef.pathologies}</textarea>
                  <textarea placeholder="Souhaits musicaux" onchange="updateBeneficiaire('${
                    intervention.id
                  }', ${
            state.selectedBeneficiaire
          }, 'souhaitsMusicaux', this.value)" ${
            !canEdit("white") ? "disabled" : ""
          } class="px-3 py-2 border rounded-lg ${
            !canEdit("white") ? "bg-gray-100" : ""
          }" rows="2">${benef.souhaitsMusicaux}</textarea>
                </div>
                <div class="mt-4">
                  <textarea placeholder="Objectifs de l'√©tablissement" onchange="updateBeneficiaire('${intervention
