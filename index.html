<!DOCTYPE html>

<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haltes Musicales</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const Icons = {
      Calendar: ({ size = 24 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
      LogOut: ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
      Plus: ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
      FileDown: ({ size = 20 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 18 15 15"/></svg>,
      Lock: ({ size = 18 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
      Users: ({ size = 14 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
      Trash: ({ size = 18 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
    };
    const ADMIN_CODE = 'ADMIN2024';
    const DEFAULT_USERS = { professionnels: [], invites: [] };
    const EVALUATION_STRUCTURE = {
      interactionsSociales: { title: "INTERACTIONS SOCIALES", items: [
        { key: "attitudeHabituelle", label: "Attitude habituelle", moments: [1,2,3,4], type: "invite", fieldType: "text" },
        { key: "interaction", label: "Interaction Sociale (échanges avec les personnes présentes)", moments: [1,2,3,4], type: "yellow" },
        { key: "reactionEmotionnelle", label: "Réaction émotionnelle", moments: [1,2,3,4], type: "yellow" },
        { key: "reactionSuiteHalte", label: "Réaction suite à la halte", moments: [1,2,3,4], type: "invite", fieldType: "text" }
      ]},
      stimulationSensorielle: { title: "STIMULATION MULTISENSORIELLE", items: [
        { key: "attitudeHabituelle", label: "Attitude habituelle", moments: [1,2,3,4], type: "invite", fieldType: "text" },
        { key: "reactionAuditive", label: "Réaction auditive (réceptivité à la musique)", moments: [1,2,3,4], type: "yellow" },
        { key: "reactionVisuelle", label: "Réaction visuelle (réceptivité aux éléments visuels)", moments: [1,2,3,4], type: "yellow" },
        { key: "reactionKinesth", label: "Réaction kinesthésique (mouvement, danse)", moments: [1,2,3,4], type: "yellow" },
        { key: "reactionSuiteHalte", label: "Réaction suite à la halte", moments: [1,2,3,4], type: "invite", fieldType: "text" }
      ]},
      memoire: { title: "MÉMOIRE / SOUVENIRS", items: [
        { key: "attitudeHabituelle", label: "Attitude habituelle", moments: [1,2,3,4], type: "invite", fieldType: "text" },
        { key: "reactivationSouvenirs", label: "Réactivation et verbalisation de souvenirs", moments: [1,2,3,4], type: "yellow" },
        { key: "reconnaissanceMusique", label: "Reconnaissance de la musique", moments: [1,2,3,4], type: "yellow" },
        { key: "reactionEmotionnelle2", label: "Réaction émotionnelle", moments: [1,2,3,4], type: "yellow" },
        { key: "reactionSuiteHalte", label: "Réaction suite à la halte", moments: [1,2,3,4], type: "invite", fieldType: "text" }
      ]},
      comportements: { title: "COMPORTEMENTS", items: [
        { key: "ideesDelirantes", label: "Idées délirantes", moments: [1,2,3,4], type: "white" },
        { key: "hallucinations", label: "Hallucinations", moments: [1,2,3,4], type: "white" },
        { key: "agitation", label: "Agitation/Agressivité", moments: [1,2,3,4], type: "white" },
        { key: "depression", label: "Dépression/Dysphorie", moments: [1,2,3,4], type: "white" },
        { key: "anxiete", label: "Anxiété", moments: [1,2,3,4], type: "white" },
        { key: "euphorie", label: "Exaltation de l'humeur / Euphorie", moments: [1,2,3,4], type: "white" },
        { key: "apathie", label: "Apathie / Indifférence", moments: [1,2,3,4], type: "white" },
        { key: "desinhibition", label: "Désinhibition", moments: [1,2,3,4], type: "white" },
        { key: "irritabilite", label: "Irritabilité / Instabilité de l'humeur", moments: [1,2,3,4], type: "white" },
        { key: "moteurAberrant", label: "Comportement moteur aberrant", moments: [1,2,3,4], type: "white" }
      ]}
    };
    const MOMENT_LABELS = { 1: "Intervention 1", 2: "Intervention 2", 3: "Intervention 3", 4: "Intervention 4" };
    function createEmptyEvaluation() {
      return {
        id: Date.now().toString() + Math.random(),
        beneficiaire: { nom: '', prenom: '', dateNaissance: '', sexe: 'Féminin' },
        pathologies: '', souhaitsMusicaux: '', objectifs: '', compteRenduMut: '', compteRenduEtablissement: '',
        dates: [
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 1' },
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 2' },
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 3' },
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 4' }
        ]
      };
    }
    function HaltesMusicalesApp() {
      const [currentUser, setCurrentUser] = useState(null);
      const [loginData, setLoginData] = useState({ email: '', password: '' });
      const [loginError, setLoginError] = useState('');
      const [users, setUsers] = useState(DEFAULT_USERS);
      const [interventions, setInterventions] = useState({});
      const [showAddModal, setShowAddModal] = useState(false);
      const [showAdminPanel, setShowAdminPanel] = useState(false);
      const [notification, setNotification] = useState(null);
      const [newIntervention, setNewIntervention] = useState({ date: '', time: '', lieu: '', notes: '' });
      const [expandedIntervention, setExpandedIntervention] = useState(null);
      const [newUser, setNewUser] = useState({ name: '', password: '', type: 'professionnel' });
      const [showSignup, setShowSignup] = useState(true);
      const [showAdminLogin, setShowAdminLogin] = useState(false);
      const [signupData, setSignupData] = useState({ name: '', email: '', password: '', type: 'professionnel', etablissement: '', rgpdConsent: false });
      const [showDateTypeModal, setShowDateTypeModal] = useState(null);
      const [showRgpdModal, setShowRgpdModal] = useState(false);

```
  useEffect(() => {
    const savedUsers = localStorage.getItem('haltes_users');
    if (savedUsers) {
      try { setUsers(JSON.parse(savedUsers)); }
      catch (e) { setUsers(DEFAULT_USERS); }
    }
  }, []);
  
  useEffect(() => { if (currentUser && currentUser.type !== 'admin') loadUserData(); }, [currentUser]);
  
  const showNotif = (msg, type = 'success') => { setNotification({ msg, type }); setTimeout(() => setNotification(null), 3000); };
  const loadUserData = () => { try { const data = localStorage.getItem(`interventions_${currentUser.id}`); if (data) setInterventions(JSON.parse(data)); } catch (e) { setInterventions({}); } };
  const saveInterventions = (data) => { try { localStorage.setItem(`interventions_${currentUser.id}`, JSON.stringify(data)); } catch (e) { console.error('Erreur:', e); } };
  const saveUsers = (userData) => { localStorage.setItem('haltes_users', JSON.stringify(userData)); setUsers(userData); };
  
  const handleLogin = () => {
    if (loginData.email.trim() === 'admin' && loginData.password.trim() === ADMIN_CODE) {
      setCurrentUser({ type: 'admin', name: 'Administrateur', id: 'admin' });
      showNotif('Bienvenue Administrateur !');
      setShowAdminPanel(true);
      setShowAdminLogin(false);
      return;
    }
    const allUsers = [...users.professionnels, ...users.invites];
    const user = allUsers.find(u => u.email === loginData.email.trim() && u.password === loginData.password.trim());
    if (user) { setCurrentUser(user); showNotif(`Bienvenue ${user.name} !`); setShowSignup(false); }
    else { setLoginError('Email ou mot de passe incorrect'); }
  };
  
  const handleSignup = () => {
    if (!signupData.name || !signupData.password || !signupData.email) {
      showNotif('Remplissez tous les champs obligatoires', 'error'); return;
    }
    if (signupData.password.length < 8) {
      showNotif('Le mot de passe doit contenir au moins 8 caractères', 'error'); return;
    }
    if (!signupData.rgpdConsent) {
      showNotif('Vous devez accepter la politique de confidentialité', 'error'); return;
    }
    const allUsers = [...users.professionnels, ...users.invites];
    if (allUsers.find(u => u.email === signupData.email)) {
      showNotif('Cet email existe déjà', 'error'); return;
    }
    const userData = { ...users };
    const id = Date.now().toString();
    const userToAdd = { name: signupData.name, email: signupData.email, password: signupData.password, type: signupData.type, id, etablissement: signupData.etablissement || '', createdAt: new Date().toISOString(), rgpdConsent: true };
    if (signupData.type === 'professionnel') userData.professionnels.push(userToAdd);
    else userData.invites.push(userToAdd);
    saveUsers(userData);
    setCurrentUser(userToAdd);
    showNotif('Compte créé avec succès !');
    setShowSignup(false);
  };
  
  const handleAddUser = () => {
    if (!newUser.name || !newUser.password) {
      showNotif('Remplissez tous les champs', 'error'); return;
    }
    const allUsers = [...users.professionnels, ...users.invites];
    if (allUsers.find(u => u.name === newUser.name)) {
      showNotif('Ce nom existe déjà', 'error'); return;
    }
    const userData = { ...users };
    const id = Date.now().toString();
    const userToAdd = { ...newUser, id };
    if (newUser.type === 'professionnel') userData.professionnels.push(userToAdd);
    else userData.invites.push(userToAdd);
    saveUsers(userData);
    setNewUser({ name: '', password: '', type: 'professionnel' });
    showNotif('Utilisateur ajouté !');
  };
  
  const handleDeleteUser = (userId, type) => {
    const userData = { ...users };
    if (type === 'professionnel') userData.professionnels = userData.professionnels.filter(u => u.id !== userId);
    else userData.invites = userData.invites.filter(u => u.id !== userId);
    saveUsers(userData);
    showNotif('Utilisateur supprimé');
  };
  
  const handleAddIntervention = () => {
    if (!newIntervention.date || !newIntervention.time || !newIntervention.lieu) {
      showNotif('Remplissez tous les champs', 'error'); return;
    }
    const id = Date.now().toString();
    const updated = { ...interventions, [id]: { ...newIntervention, id, beneficiaires: [] }};
    setInterventions(updated); saveInterventions(updated); setShowAddModal(false);
    setNewIntervention({ date: '', time: '', lieu: '', notes: '' });
    showNotif('Intervention créée !');
  };
  
  const canEdit = (fieldType) => {
    if (!currentUser) return false;
    if (fieldType === 'comment' || fieldType === 'yellow') return true;
    if (fieldType === 'white') return currentUser.type === 'professionnel';
    if (fieldType === 'invite') return currentUser.type === 'invite';
    return false;
  };
  
  const handleAddBeneficiaire = (interventionId) => {
    const newBenef = createEmptyEvaluation();
    const updated = { ...interventions };
    if (!updated[interventionId].beneficiaires) updated[interventionId].beneficiaires = [];
    updated[interventionId].beneficiaires.push(newBenef);
    setInterventions(updated); saveInterventions(updated);
    showNotif('Bénéficiaire ajouté !');
  };
  
  const updateBeneficiaire = (interventionId, benefIndex, field, value) => {
    const updated = { ...interventions };
    const benef = updated[interventionId].beneficiaires[benefIndex];
    if (field.includes('.')) {
      const [parent, child] = field.split('.');
      benef[parent][child] = value;
    } else benef[field] = value;
    setInterventions(updated); saveInterventions(updated);
  };
  
  const updateEvaluation = (interventionId, benefIndex, dateIndex, category, itemKey, moment, value) => {
    const updated = { ...interventions };
    const benef = updated[interventionId].beneficiaires[benefIndex];
    if (!benef.dates[dateIndex].evaluations[category]) benef.dates[dateIndex].evaluations[category] = {};
    if (!benef.dates[dateIndex].evaluations[category][itemKey]) benef.dates[dateIndex].evaluations[category][itemKey] = {};
    benef.dates[dateIndex].evaluations[category][itemKey][moment] = value;
    setInterventions(updated); saveInterventions(updated);
  };
  
  const updateComment = (interventionId, benefIndex, dateIndex, category, itemKey, value) => {
    const updated = { ...interventions };
    const benef = updated[interventionId].beneficiaires[benefIndex];
    if (!benef.dates[dateIndex].commentaires[category]) benef.dates[dateIndex].commentaires[category] = {};
    benef.dates[dateIndex].commentaires[category][itemKey] = value;
    setInterventions(updated); saveInterventions(updated);
  };
  
  const updateDate = (interventionId, benefIndex, dateIndex, value) => {
    const updated = { ...interventions };
    updated[interventionId].beneficiaires[benefIndex].dates[dateIndex].date = value;
    setInterventions(updated); saveInterventions(updated);
  };
  
  const addNewDate = (interventionId, benefIndex, dateType) => {
    const updated = { ...interventions };
    const benef = updated[interventionId].beneficiaires[benefIndex];
    const currentInterventionCount = benef.dates.filter(d => d.label && d.label.startsWith('Intervention')).length;
    const currentVRCount = benef.dates.filter(d => d.label && d.label.startsWith('Date VR')).length;
    const label = dateType === 'intervention' ? `Intervention ${currentInterventionCount + 1}` : `Date VR ${currentVRCount + 1}`;
    benef.dates.push({ date: '', evaluations: {}, commentaires: {}, label: label });
    setInterventions(updated); saveInterventions(updated);
    showNotif(`${label} ajoutée !`); setShowDateTypeModal(null);
  };
  
  const generatePDF = () => { showNotif('Fonctionnalité PDF en développement'); };
  
  if (!currentUser) {
    // Pages de connexion/inscription - code complet dans l'artifact principal
    return <div>Voir artifact principal pour le code complet</div>;
  }
  
  const interventionsList = Object.values(interventions).sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
  return <div>Application principale - voir artifact principal</div>;
}
ReactDOM.render(<HaltesMusicalesApp />, document.getElementById('root'));
```

  </script>
</body>
</html>
