<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haltes Musicales</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="app"></div>
  
  <script>
const ADMIN_CODE="ADMIN2024";const EVALUATION_STRUCTURE={interactionsSociales:{title:"INTERACTIONS SOCIALES",items:[{key:"attitudeHabituelle",label:"Attitude habituelle",moments:[1,2,3,4],type:"invite",fieldType:"text"},{key:"interaction",label:"Interaction Sociale (√©changes avec les personnes pr√©sentes)",moments:[1,2,3,4],type:"yellow"},{key:"reactionEmotionnelle",label:"R√©action √©motionnelle",moments:[1,2,3,4],type:"yellow"},{key:"reactionSuiteHalte",label:"R√©action suite √† la halte",moments:[1,2,3,4],type:"invite",fieldType:"text"}]},stimulationSensorielle:{title:"STIMULATION MULTISENSORIELLE",items:[{key:"attitudeHabituelle",label:"Attitude habituelle",moments:[1,2,3,4],type:"invite",fieldType:"text"},{key:"reactionAuditive",label:"R√©action auditive (r√©ceptivit√© √† la musique)",moments:[1,2,3,4],type:"yellow"},{key:"reactionVisuelle",label:"R√©action visuelle (r√©ceptivit√© aux √©l√©ments visuels)",moments:[1,2,3,4],type:"yellow"},{key:"reactionKinesth",label:"R√©action kinesth√©sique (mouvement, danse)",moments:[1,2,3,4],type:"yellow"},{key:"reactionSuiteHalte",label:"R√©action suite √† la halte",moments:[1,2,3,4],type:"invite",fieldType:"text"}]},memoire:{title:"M√âMOIRE / SOUVENIRS",items:[{key:"attitudeHabituelle",label:"Attitude habituelle",moments:[1,2,3,4],type:"invite",fieldType:"text"},{key:"reactivationSouvenirs",label:"R√©activation et verbalisation de souvenirs",moments:[1,2,3,4],type:"yellow"},{key:"reconnaissanceMusique",label:"Reconnaissance de la musique",moments:[1,2,3,4],type:"yellow"},{key:"reactionEmotionnelle2",label:"R√©action √©motionnelle",moments:[1,2,3,4],type:"yellow"},{key:"reactionSuiteHalte",label:"R√©action suite √† la halte",moments:[1,2,3,4],type:"invite",fieldType:"text"}]},comportements:{title:"COMPORTEMENTS",items:[{key:"ideesDelirantes",label:"Id√©es d√©lirantes",moments:[1,2,3,4],type:"white"},{key:"hallucinations",label:"Hallucinations",moments:[1,2,3,4],type:"white"},{key:"agitation",label:"Agitation/Agressivit√©",moments:[1,2,3,4],type:"white"},{key:"depression",label:"D√©pression/Dysphorie",moments:[1,2,3,4],type:"white"},{key:"anxiete",label:"Anxi√©t√©",moments:[1,2,3,4],type:"white"},{key:"euphorie",label:"Exaltation de l'humeur / Euphorie",moments:[1,2,3,4],type:"white"},{key:"apathie",label:"Apathie / Indiff√©rence",moments:[1,2,3,4],type:"white"},{key:"desinhibition",label:"D√©sinhibition",moments:[1,2,3,4],type:"white"},{key:"irritabilite",label:"Irritabilit√© / Instabilit√© de l'humeur",moments:[1,2,3,4],type:"white"},{key:"moteurAberrant",label:"Comportement moteur aberrant",moments:[1,2,3,4],type:"white"}]}};let state={currentUser:null,users:{professionnels:[],invites:[]},interventions:{},view:"signup",loginError:"",expandedIntervention:null,selectedBeneficiaire:null,inviteToken:null};function init(){try{const e=localStorage.getItem("haltes_users");e&&(state.users=JSON.parse(e))}catch(e){}const e=new URLSearchParams(window.location.search).get("token");e&&(state.inviteToken=e,state.view="invite-login"),render()}function showNotif(e,t="success"){const n=document.createElement("div");n.className=`fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${"success"===t?"bg-green-500":"bg-red-500"}`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>n.remove(),3e3)}function canEdit(e){return!!state.currentUser&&("comment"===e||"yellow"===e||("white"===e?"professionnel"===state.currentUser.type:"invite"===e&&"invite"===state.currentUser.type))}function createEmptyEvaluation(){return{id:Date.now().toString()+Math.random(),beneficiaire:{nom:"",prenom:"",dateNaissance:"",sexe:"F√©minin"},pathologies:"",souhaitsMusicaux:"",objectifs:"",compteRenduMut:"",compteRenduEtablissement:"",dates:[{date:"",evaluations:{},commentaires:{},label:"Intervention 1",type:"intervention"},{date:"",evaluations:{},commentaires:{},label:"Intervention 2",type:"intervention"},{date:"",evaluations:{},commentaires:{},label:"Intervention 3",type:"intervention"},{date:"",evaluations:{},commentaires:{},label:"Intervention 4",type:"intervention"}]}}function saveInterventions(){if(!state.currentUser||"admin"===state.currentUser.type)return;try{localStorage.setItem(`interventions_${state.currentUser.id}`,JSON.stringify(state.interventions))}catch(e){console.error("Erreur sauvegarde",e)}}function updateBeneficiaire(e,t,n,a){const i=state.interventions[e].beneficiaires[t];if(n.includes(".")){const[e,t]=n.split(".");i[e][t]=a}else i[n]=a;saveInterventions()}function updateEvaluation(e,t,n,a,i,s,r){const o=state.interventions[e].beneficiaires[t];o.dates[n].evaluations[a]||(o.dates[n].evaluations[a]={}),o.dates[n].evaluations[a][i]||(o.dates[n].evaluations[a][i]={}),o.dates[n].evaluations[a][i][s]=r,saveInterventions()}function updateComment(e,t,n,a,i,s){const r=state.interventions[e].beneficiaires[t];r.dates[n].commentaires[a]||(r.dates[n].commentaires[a]={}),r.dates[n].commentaires[a][i]=s,saveInterventions()}function generateToken(){return"invite_"+Math.random().toString(36).substr(2,9)+Date.now().toString(36)}function closeAllModals(){document.querySelectorAll(".fixed.inset-0").forEach(e=>e.remove())}function copyInviteLink(e){const t=state.interventions[e],n=window.location.origin+window.location.pathname+"?token="+t.inviteToken;navigator.clipboard.writeText(n).then(()=>{showNotif("Lien copi√© dans le presse-papier !")}).catch(()=>{const e=document.createElement("div");e.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",e.innerHTML=`\n      <div class="bg-white rounded-2xl p-6 w-full max-w-2xl shadow-2xl">\n        <div class="flex justify-between items-center mb-4">\n          <h3 class="text-xl font-bold text-gray-900">Lien d'acc√®s pour l'√©tablissement</h3>\n          <button onclick="closeAllModals()" class="text-gray-400 hover:text-gray-600"><span class="text-2xl">√ó</span></button>\n        </div>\n        <div class="bg-gray-50 p-4 rounded-lg mb-4">\n          <input type="text" value="${n}" readonly class="w-full px-3 py-2 border rounded-lg text-sm" id="link-to-copy">\n        </div>\n        <button onclick="document.getElementById('link-to-copy').select(); document.execCommand('copy'); showNotif('Lien copi√© !'); closeAllModals();" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">\n          Copier le lien\n        </button>\n      </div>\n    `,document.body.appendChild(e)})}function switchView(e){state.view=e,state.loginError="",render()}function handleSignup(){const e=document.getElementById("name").value,t=document.getElementById("email").value,n=document.getElementById("password").value,a=document.getElementById("type").value,i=document.getElementById("etablissement")?.value||"";if(!document.getElementById("rgpd").checked)return void showNotif("Vous devez accepter la politique de confidentialit√©","error");if(!e||!t||!n)return void showNotif("Remplissez tous les champs obligatoires","error");if(n.length<8)return void showNotif("Le mot de passe doit contenir au moins 8 caract√®res","error");if([...state.users.professionnels,...state.users.invites].find(e=>e.email===t))return void showNotif("Cet email existe d√©j√†","error");const s=Date.now().toString(),r={name:e,email:t,password:n,type:a,id:s,etablissement:i,createdAt:(new Date).toISOString(),rgpdConsent:!0};"professionnel"===a?state.users.professionnels.push(r):state.users.invites.push(r),localStorage.setItem("haltes_users",JSON.stringify(state.users)),state.currentUser=r;try{const e=localStorage.getItem(`interventions_${r.id}`);state.interventions=e?JSON.parse(e):{}}catch(e){state.interventions={}}showNotif("Compte cr√©√© avec succ√®s !"),render()}function handleLogin(){const e=document.getElementById("email").value,t=document.getElementById("password").value;if("admin"===e&&t===ADMIN_CODE)return state.currentUser={type:"admin",name:"Administrateur",id:"admin"},showNotif("Bienvenue Administrateur !"),void render();const n=[...state.users.professionnels,...state.users.invites].find(n=>n.email===e&&n.password===t);if(n){state.currentUser=n;try{const e=localStorage.getItem(`interventions_${n.id}`);state.interventions=e?JSON.parse(e):{}}catch(e){state.interventions={}}showNotif(`Bienvenue ${n.name} !`),render()}else state.loginError="Email ou mot de passe incorrect",render()}function handleInviteLogin(){const e=document.getElementById("email").value,t=document.getElementById("password").value,n=state.users.invites.find(n=>n.email===e&&n.password===t);if(n){state.currentUser=n;const e={};state.users.professionnels.forEach(t=>{try{const n=localStorage.getItem(`interventions_${t.id}`);if(n){const t=JSON.parse(n);Object.assign(e,t)}}catch(e){}});const t=Object.values(e).find(e=>e.inviteToken===state.inviteToken);t?(state.interventions={[t.id]:t},state.expandedIntervention=t.id,showNotif(`Bienvenue ${n.name} !`),render()):(state.loginError="Lien d'acc√®s invalide ou expir√©",render())}else state.loginError="Email ou mot de passe incorrect",render()}function logout(){state.currentUser=null,state.interventions={},state.view="signup",state.expandedIntervention=null,state.selectedBeneficiaire=null,state.inviteToken=null,render()}function showAddModal(){document.querySelectorAll(".fixed.inset-0").forEach(e=>e.remove());const e=document.createElement("div");e.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",e.id="intervention-modal",e.innerHTML='\n    <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">\n      <div class="flex justify-between items-center mb-6">\n        <h3 class="text-xl font-bold text-gray-900">Nouvelle intervention</h3>\n        <button onclick="document.getElementById(\'intervention-modal\').remove()" class="text-gray-400 hover:text-gray-600">\n          <span class="text-2xl">√ó</span>\n        </button>\n      </div>\n      <div class="space-y-4">\n        <input type="date" id="modal-date" class="w-full px-4 py-2 border rounded-lg">\n        <input type="time" id="modal-time" class="w-full px-4 py-2 border rounded-lg">\n        <input type="text" id="modal-lieu" placeholder="Lieu" class="w-full px-4 py-2 border rounded-lg">\n        <div class="flex gap-3">\n          <button onclick="document.getElementById(\'intervention-modal\').remove()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">Annuler</button>\n          <button onclick="saveIntervention()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Ajouter</button>\n        </div>\n      </div>\n    </div>\n  ',document.body.appendChild(e)}function saveIntervention(){const e=document.getElementById("modal-date").value,t=document.getElementById("modal-time").value,n=document.getElementById("modal-lieu").value;if(!e||!t||!n)return void showNotif("Remplissez tous les champs","error");const a=Date.now().toString(),i=generateToken();state.interventions[a]={id:a,date:e,time:t,lieu:n,beneficiaires:[],createdBy:state.currentUser.id,createdByName:state.currentUser.name,createdByType:state.currentUser.type,etablissement:state.currentUser.etablissement||"",inviteToken:i},saveInterventions();const s=document.getElementById("intervention-modal");s&&s.remove(),document.querySelectorAll(".fixed.inset-0").forEach(e=>e.remove()),state.expandedIntervention=a,showNotif("Intervention cr√©√©e !"),render()}function viewIntervention(e){state.expandedIntervention=e,state.selectedBeneficiaire=null,render()}function backToList(){state.expandedIntervention=null,state.selectedBeneficiaire=null,render()}function backToBeneficiaires(){state.selectedBeneficiaire=null,render()}function selectBeneficiaire(e){state.selectedBeneficiaire=e,render()}function addDateColumn(interventionId,benefIndex,type){const benef=state.interventions[interventionId].beneficiaires[benefIndex];const count=benef.dates.filter(d=>d.type===type).length+1;const label=type==="vr"?`Session VR ${count}`:`Intervention ${count}`;benef.dates.push({date:"",evaluations:{},commentaires:{},label:label,type:type});saveInterventions();render()}function showAddColumnModal(interventionId,benefIndex){closeAllModals();const modal=document.createElement("div");modal.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50";modal.id="add-column-modal";modal.innerHTML=`<div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl"><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-gray-900">Ajouter une colonne</h3><button onclick="closeAllModals()" class="text-gray-400 hover:text-gray-600"><span class="text-2xl">√ó</span></button></div><div class="space-y-3"><button onclick="addDateColumn('${interventionId}',${benefIndex},'intervention');closeAllModals()" class="w-full px-6 py-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-left flex items-center gap-3"><span class="text-2xl">üéµ</span><div><div class="font-semibold">Intervention classique</div><div class="text-sm opacity-90">Ajouter une nouvelle halte musicale</div></div></button><button onclick="addDateColumn('${interventionId}',${benefIndex},'vr');closeAllModals()" class="w-full px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-left flex items-center gap-3"><span class="text-2xl">ü•Ω</span><div><div class="font-semibold">Session VR</div><div class="text-sm opacity-90">Ajouter une session de r√©alit√© virtuelle</div></div></button></div></div>`;document.body.appendChild(modal)}function generatePDF(interventionId,benefIndex){const intervention=state.interventions[interventionId];const benef=intervention.beneficiaires[benefIndex];showNotif("G√©n√©ration du rapport PDF avec analyses...");const analyses=analyzeEvolution(benef);const groupAnalysis=analyzeGroup(intervention);const pdfContent=`
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Rapport Haltes Musicales - ${benef.beneficiaire.nom} ${benef.beneficiaire.prenom}</title>
<style>
body{font-family:Arial,sans-serif;margin:40px;color:#333}
h1{color:#7c3aed;border-bottom:3px solid #7c3aed;padding-bottom:10px}
h2{color:#5b21b6;margin-top:30px;border-left:4px solid #7c3aed;padding-left:15px}
.info-box{background:#f3f4f6;padding:15px;border-radius:8px;margin:20px 0}
.objectifs{background:#dbeafe;padding:15px;border-left:4px solid #2563eb;margin:20px 0}
.analysis{background:#fef3c7;padding:15px;border-radius:8px;margin:20px 0}
.positive{color:#059669;font-weight:bold}
.negative{color:#dc2626;font-weight:bold}
.neutral{color:#6b7280;font-weight:bold}
table{width:100%;border-collapse:collapse;margin:20px 0}
th,td{border:1px solid #d1d5db;padding:8px;text-align:left}
th{background:#7c3aed;color:white}
.chart{margin:30px 0;padding:20px;background:#f9fafb;border-radius:8px}
</style>
</head>
<body>
<h1>Rapport d'√âvaluation - Haltes Musicales</h1>
<div class="info-box">
<h3>Informations du B√©n√©ficiaire</h3>
<p><strong>Nom :</strong> ${benef.beneficiaire.nom} ${benef.beneficiaire.prenom}</p>
<p><strong>Date de naissance :</strong> ${benef.beneficiaire.dateNaissance?new Date(benef.beneficiaire.dateNaissance).toLocaleDateString("fr-FR"):"Non renseign√©e"}</p>
<p><strong>Sexe :</strong> ${benef.beneficiaire.sexe}</p>
<p><strong>Pathologies :</strong> ${benef.pathologies||"Non renseign√©es"}</p>
<p><strong>Souhaits musicaux :</strong> ${benef.souhaitsMusicaux||"Non renseign√©s"}</p>
</div>
<div class="objectifs">
<h3>üìã Objectifs fix√©s par l'√©tablissement</h3>
<p>${benef.objectifs||"Aucun objectif sp√©cifi√©"}</p>
</div>
<h2>üìä Analyse Individuelle de l'√âvolution</h2>
${generateIndividualAnalysis(benef,analyses)}
<h2>üë• Analyse de Groupe</h2>
${generateGroupAnalysis(intervention,groupAnalysis)}
<h2>üí° Recommandations</h2>
${generateRecommendations(benef,analyses)}
<div style="margin-top:50px;padding-top:20px;border-top:2px solid #e5e7eb">
<p><strong>Compte-rendu du psychologue Mut :</strong></p>
<p>${benef.compteRenduMut||"Non renseign√©"}</p>
<p style="margin-top:20px"><strong>Compte-rendu du psychologue de l'√©tablissement :</strong></p>
<p>${benef.compteRenduEtablissement||"Non renseign√©"}</p>
</div>
<div style="margin-top:30px;text-align:center;color:#6b7280;font-size:12px">
<p>Document g√©n√©r√© le ${new Date().toLocaleDateString("fr-FR")} - Haltes Musicales</p>
</div>
</body>
</html>`;const win=window.open("","_blank");win.document.write(pdfContent);win.document.close();win.print()}function analyzeEvolution(benef){const categories=["interactionsSociales","stimulationSensorielle","memoire","comportements"];const evolution={};categories.forEach(cat=>{const items=EVALUATION_STRUCTURE[cat].items.filter(i=>i.type==="yellow");const scores=benef.dates.map((date,idx)=>{let total=0,count=0;items.forEach(item=>{const val=date.evaluations?.[cat]?.[item.key]?.[idx+1];if(val){const score={"Aucune":0,"Faible":1,"Mod√©r√©e":2,"Bonne":3,"Excellente":4}[val];if(score!==undefined){total+=score;count++}}});return count>0?total/count:null});evolution[cat]={scores:scores.filter(s=>s!==null),trend:calculateTrend(scores.filter(s=>s!==null))}});return evolution}function calculateTrend(scores){if(scores.length<2)return"stable";const first=scores[0];const last=scores[scores.length-1];const diff=last-first;if(diff>0.5)return"am√©lioration";if(diff<-0.5)return"r√©gression";return"stable"}function analyzeGroup(intervention){if(!intervention.beneficiaires||intervention.beneficiaires.length<2)return null;const categories=["interactionsSociales","stimulationSensorielle","memoire"];const groupScores={};categories.forEach(cat=>{const allScores=intervention.beneficiaires.map(b=>analyzeEvolution(b)[cat].scores);const avgByDate=[];for(let i=0;i<4;i++){const scores=allScores.map(s=>s[i]).filter(s=>s!==undefined);if(scores.length>0){avgByDate.push(scores.reduce((a,b)=>a+b,0)/scores.length)}}groupScores[cat]={avg:avgByDate,trend:calculateTrend(avgByDate)}});return groupScores}function generateIndividualAnalysis(benef,analyses){let html='<div class="analysis">';Object.entries(analyses).forEach(([cat,data])=>{const catName=EVALUATION_STRUCTURE[cat].title;const trendText=data.trend==="am√©lioration"?'<span class="positive">‚Üó Am√©lioration significative</span>':data.trend==="r√©gression"?'<span class="negative">‚Üò R√©gression observ√©e</span>':'<span class="neutral">‚Üí Stabilit√©</span>';html+=`<h3>${catName}</h3><p><strong>Tendance :</strong> ${trendText}</p>`;if(data.scores.length>0){const chart=generateAsciiChart(data.scores);html+=`<div class="chart"><pre>${chart}</pre></div>`}});html+='</div>';return html}function generateGroupAnalysis(intervention,groupAnalysis){if(!groupAnalysis)return'<p>Analyse de groupe non disponible (moins de 2 b√©n√©ficiaires)</p>';let html='<div class="analysis"><p><strong>Nombre de participants :</strong> '+intervention.beneficiaires.length+'</p>';Object.entries(groupAnalysis).forEach(([cat,data])=>{const catName=EVALUATION_STRUCTURE[cat].title;const trendText=data.trend==="am√©lioration"?'<span class="positive">‚Üó Progr√®s collectif</span>':data.trend==="r√©gression"?'<span class="negative">‚Üò Difficult√© collective</span>':'<span class="neutral">‚Üí Groupe stable</span>';html+=`<h3>${catName} (Moyenne du groupe)</h3><p><strong>Tendance :</strong> ${trendText}</p>`;if(data.avg.length>0){const chart=generateAsciiChart(data.avg);html+=`<div class="chart"><pre>${chart}</pre></div>`}});html+='</div>';return html}function generateRecommendations(benef,analyses){let recs=[];Object.entries(analyses).forEach(([cat,data])=>{if(data.trend==="am√©lioration"){recs.push(`‚úÖ <strong>${EVALUATION_STRUCTURE[cat].title}</strong> : Poursuivre les interventions actuelles qui montrent une efficacit√© positive.`)}else if(data.trend==="r√©gression"){recs.push(`‚ö†Ô∏è <strong>${EVALUATION_STRUCTURE[cat].title}</strong> : Envisager un ajustement du programme ou une consultation compl√©mentaire.`)}});if(benef.objectifs){recs.push(`üéØ <strong>Objectifs √©tablissement :</strong> √âvaluer l'atteinte des objectifs fix√©s : "${benef.objectifs}"`)}if(recs.length===0){recs.push("‚ÑπÔ∏è Continuer le suivi r√©gulier et maintenir les interventions actuelles.")}return'<ul>'+recs.map(r=>`<li style="margin:10px 0">${r}</li>`).join('')+'</ul>'}function generateAsciiChart(scores){const max=4;const height=10;const width=scores.length*4;let chart='';for(let i=height;i>=0;i--){let line='';for(let j=0;j<scores.length;j++){const normalized=Math.round((scores[j]/max)*height);line+=normalized>=i?'‚ñà':'¬∑';line+='   '}chart+=line+'\n'}chart+='\n'+'‚Äï'.repeat(width)+'\n';chart+='   '+scores.map((_,i)=>`I${i+1}`).join('  ')+'\n';return chart}function addBeneficiaire(interventionId){const benef=createEmptyEvaluation();if(!state.interventions[interventionId].beneficiaires){state.interventions[interventionId].beneficiaires=[]}state.interventions[interventionId].beneficiaires.push(benef);saveInterventions();showNotif("B√©n√©ficiaire ajout√© !");render()}
    function render(){const e=document.getElementById("app");if(!state.currentUser){if("invite-login"===state.view)return e.innerHTML=`<div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md"><div class="text-center mb-8"><span class="text-6xl">üéµ</span><h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Haltes Musicales</h1><p class="text-gray-600">Acc√®s √âtablissement</p></div><div class="space-y-6"><div class="bg-blue-50 border border-blue-200 rounded-lg p-4"><p class="text-sm text-blue-900">Vous avez √©t√© invit√© √† consulter une intervention. Veuillez vous connecter ou cr√©er un compte.</p></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" id="email" class="w-full px-4 py-3 border rounded-lg" placeholder="email@exemple.fr"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label><input type="password" id="password" class="w-full px-4 py-3 border rounded-lg" placeholder="********"></div>${state.loginError?`<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>`:""}<button onclick="handleInviteLogin()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Se connecter</button><button onclick="switchView('signup')" class="w-full text-purple-600 hover:text-purple-700 text-sm font-medium">Cr√©er un compte √©tablissement</button></div></div></div>`,void 0;if("signup"===state.view)return e.innerHTML=`<div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md"><div class="text-center mb-8"><span class="text-6xl">üéµ</span><h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Haltes Musicales</h1><p class="text-gray-600">Cr√©er votre compte</p></div><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-700 mb-2">Nom complet *</label><input type="text" id="name" class="w-full px-4 py-3 border rounded-lg" placeholder="Dr. Marie Dupont"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Email *</label><input type="email" id="email" class="w-full px-4 py-3 border rounded-lg" placeholder="email@exemple.fr"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe * (min. 8 car.)</label><input type="password" id="password" class="w-full px-4 py-3 border rounded-lg" placeholder="********"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Type *</label><select id="type" class="w-full px-4 py-3 border rounded-lg"><option value="professionnel">Psychologue Haltes Musicales</option><option value="invite">√âtablissement (invit√©)</option></select></div><div id="etablissement-field" class="hidden"><label class="block text-sm font-medium text-gray-700 mb-2">√âtablissement</label><input type="text" id="etablissement" class="w-full px-4 py-3 border rounded-lg" placeholder="EHPAD Les Jardins"></div><div class="bg-blue-50 border border-blue-200 rounded-lg p-4"><label class="flex items-start gap-3 text-sm"><input type="checkbox" id="rgpd" class="mt-1"><span>J'accepte la politique de confidentialit√© *</span></label></div>${state.loginError?`<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>`:""}<button onclick="handleSignup()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Cr√©er mon compte</button><button onclick="switchView('login')" class="w-full text-purple-600 hover:text-purple-700 text-sm font-medium">J'ai d√©j√† un compte</button><button onclick="switchView('admin')" class="w-full text-gray-400 hover:text-gray-600 text-xs pt-4 border-t">Acc√®s admin</button></div></div></div>`,document.getElementById("type").addEventListener("change",e=>{document.getElementById("etablissement-field").classList.toggle("hidden","invite"!==e.target.value)}),void 0;if("login"===state.view)return e.innerHTML=`<div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md"><div class="text-center mb-8"><span class="text-6xl">üéµ</span><h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Haltes Musicales</h1><p class="text-gray-600">Connexion</p></div><div class="space-y-6"><div><label class="block text-sm font-medium text-gray-700 mb-2">Email</label><input type="email" id="email" class="w-full px-4 py-3 border rounded-lg" placeholder="email@exemple.fr"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label><input type="password" id="password" class="w-full px-4 py-3 border rounded-lg" placeholder="********"></div>${state.loginError?`<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>`:""}<button onclick="handleLogin()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Se connecter</button><button onclick="switchView('signup')" class="w-full text-purple-600 hover:text-purple-700 text-sm font-medium">Cr√©er un compte</button></div></div></div>`,void 0;if("admin"===state.view)return e.innerHTML=`<div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4"><div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md"><div class="text-center mb-8"><span class="text-6xl">üîí</span><h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Administration</h1><p class="text-gray-600">Acc√®s r√©serv√©</p></div><div class="space-y-6"><div><label class="block text-sm font-medium text-gray-700 mb-2">Email administrateur</label><input type="text" id="email" class="w-full px-4 py-3 border rounded-lg" placeholder="admin"></div><div><label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label><input type="password" id="password" class="w-full px-4 py-3 border rounded-lg" placeholder="Mot de passe"></div>${state.loginError?`<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>`:""}<button onclick="handleLogin()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Se connecter</button><button onclick="switchView('signup')" class="w-full text-gray-600 hover:text-gray-800 text-sm">‚Üê Retour</button></div></div></div>`,void 0}if("admin"===state.currentUser.type)return e.innerHTML=`<div class="min-h-screen bg-gray-50"><header class="bg-white shadow-sm border-b sticky top-0 z-40"><div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between"><div class="flex items-center gap-4"><span class="text-4xl">üéµ</span><div><h1 class="text-2xl font-bold text-purple-900">Administration</h1><p class="text-sm text-gray-600">Gestion des utilisateurs</p></div></div><button onclick="logout()" class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">D√©connexion</button></div></header><div class="max-w-7xl mx-auto px-4 py-6"><div class="grid md:grid-cols-2 gap-6"><div class="bg-white rounded-xl shadow p-6"><h3 class="text-lg font-bold text-gray-900 mb-4">Psychologues (${state.users.professionnels.length})</h3><div class="space-y-3">${state.users.professionnels.map(e=>`<div class="p-3 bg-purple-50 rounded-lg"><p class="font-medium text-gray-900">${e.name}</p><p class="text-sm text-gray-600">${e.email}</p></div>`).join("")||'<p class="text-gray-400 text-sm">Aucun psychologue</p>'}</div></div><div class="bg-white rounded-xl shadow p-6"><h3 class="text-lg font-bold text-gray-900 mb-4">√âtablissements (${state.users.invites.length})</h3><div class="space-y-3">${state.users.invites.map(e=>`<div class="p-3 bg-blue-50 rounded-lg"><p class="font-medium text-gray-900">${e.name}</p><p class="text-sm text-gray-600">${e.email}</p>${e.etablissement?`<p class="text-xs text-gray-500">${e.etablissement}</p>`:""}</div>`).join("")||'<p class="text-gray-400 text-sm">Aucun √©tablissement</p>'}</div></div></div></div></div>`,void 0;const t=Object.values(state.interventions).filter(e=>e.createdBy===state.currentUser.id).sort((e,t)=>new Date(t.date)-new Date(e.date));if(state.expandedIntervention&&null!==state.selectedBeneficiaire){const t=state.interventions[state.expandedIntervention],n=t.beneficiaires[state.selectedBeneficiaire];return e.innerHTML=`<div class="min-h-screen bg-gray-50"><header class="bg-white shadow-sm border-b sticky top-0 z-40"><div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between"><button onclick="backToBeneficiaires()" class="flex items-center gap-4 hover:opacity-80"><span class="text-4xl">üéµ</span><div><h1 class="text-2xl font-bold text-purple-900">Haltes Musicales</h1><p class="text-sm text-gray-600">${n.beneficiaire.nom} ${n.beneficiaire.prenom}</p></div></button><button onclick="logout()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">D√©connexion</button></div></header><div class="max-w-7xl mx-auto px-4 py-6"><button onclick="backToBeneficiaires()" class="mb-4 text-purple-600 hover:text-purple-700 font-medium">‚Üê Retour aux b√©n√©ficiaires</button><div class="bg-white rounded-xl shadow p-6 mb-6"><h4 class="text-lg font-bold text-gray-900 mb-4">Informations du b√©n√©ficiaire</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><input type="text" placeholder="Nom" value="${n.beneficiaire.nom}" onchange="updateBeneficiaire('${t.id}',${state.selectedBeneficiaire},'beneficiaire.nom',this.value)" ${canEdit("white")?"":'disabled'} class="px-3 py-2 border rounded-lg ${canEdit("white")?"":"bg-gray-100"}"><input type="text" placeholder="Pr√©nom" value="${n.beneficiaire.prenom}" onchange="updateBeneficiaire('${t.id}',${state.selectedBeneficiaire},'beneficiaire.prenom',this.value)" ${canEdit("white")?"":'disabled'} class="px-3 py-2 border rounded-lg ${canEdit("white")?"":"bg-gray-100"}"><input type="date" value="${n.beneficiaire.dateNaissance}" onchange="updateBeneficiaire('${t.id}',${state.selectedBeneficiaire},'beneficiaire.dateNaissance',this.value)" ${canEdit("white")?"":'disabled'} class="px-3 py-2 border rounded-lg ${canEdit("white")?"":"bg-gray-100"}"><select onchange="updateBeneficiaire('${t.id}',${state.selectedBeneficiaire},'beneficiaire.sexe',this.value)" ${canEdit("white")?"":'disabled'} class="px-3 py-2 border rounded-lg ${canEdit("white")?"":"bg-gray-100"}"><option ${"F√©minin"===n.beneficiaire.sexe?"selected":""}>F√©minin</option><option ${"Masculin"===n.beneficiaire.sexe?"selected":""}>Masculin</option></select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><textarea placeholder="Pathologies" onchange="updateBeneficiaire('${t.id}',${state.selectedBeneficiaire},'pathologies',this.value)" ${canEdit("white")?"":'disabled'} class="px-3 py-2 border rounded-lg ${canEdit("white")?"":"bg-gray-100"}" rows="2">${n.pathologies}</textarea><textarea placeholder="Souhaits musicaux" onchange="updateBeneficiaire('${t.id}',${state.selectedBeneficiaire},'souhaitsMusicaux',this.value)" ${canEdit("white")?"":'disabled'} class="px-3 py-2 border rounded-lg ${canEdit("white")?"":"bg-gray-100"}" rows="2">${n.souhaitsMusicaux}</textarea></div><div class="mt-4"><textarea placeholder="Objectifs de l'√©tablissement" onchange="updateBeneficiaire('${t.id}',${state.selectedBeneficiaire},'objectifs',this.value)" ${canEdit("white")?"":'disabled'} class="w-full px-3 py-2 border rounded-lg ${canEdit("white")?"":"bg-gray-100"}" rows="3">${n.objectifs}</textarea></div></div>${Object.entries(EVALUATION_STRUCTURE).map(([e,a])=>`<div class="border rounded-lg overflow-hidden mb-6"><h6 class="font-bold text-gray-900 p-4 bg-orange-50 border-b">${a.title}</h6><div class="overflow-x-auto"><table class="w-full"><thead><tr class="bg-gray-50 border-b"><th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-1/4">Crit√®re</th>${n.dates.map((e,a)=>`<th class="px-4 py-3 text-center text-sm font-semibold ${e.type==="vr"?"text-blue-700 bg-blue-50":"text-purple-700"} border-l"><div class="flex items-center justify-center gap-2">${e.type==="vr"?"ü•Ω":""}<span>${e.label}</span></div>${e.date?`<div class="text-xs text-gray-500 font-normal mt-1">${new Date(e.date).toLocaleDateString("fr-FR")}</div>`:""}</th>`).join("")}${canEdit("white")?`<th class="px-4 py-3 text-center border-l"><button onclick="showAddColumnModal('${t.id}',${state.selectedBeneficiaire})" class="w-8 h-8 rounded-full bg-green-600 hover:bg-green-700 text-white flex items-center justify-center mx-auto text-lg font-bold">+</button></th>`:""}</tr></thead><tbody>${a.items.map((a,i)=>`<tr class="${i%2==0?"bg-white":"bg-gray-50"}"><td class="px-4 py-3 text-sm ${"yellow"===a.type?"bg-yellow-50 font-medium":"invite"===a.type?"bg-green-50 font-medium italic":"bg-gray-50 font-medium"}">${a.label}</td>${n.dates.map((i,s)=>`<td class="px-4 py-3 border-l">${a.moments.includes(s+1)||s>=4?`<div class="space-y-2">${"text"===a.fieldType?`<textarea onchange="updateEvaluation('${t.id}',${state.selectedBeneficiaire},${s},'${e}','${a.key}',${s+1},this.value)" ${canEdit(a.type)?"":'disabled'} placeholder="Texte libre..." class="w-full px-2 py-1 border rounded text-xs ${"invite"===a.type?"bg-green-50":"bg-white"} ${canEdit(a.type)?"":"bg-gray-100"}" rows="3">${i.evaluations?.[e]?.[a.key]?.[s+1]||""}</textarea>`:`<select onchange="updateEvaluation('${t.id}',${state.selectedBeneficiaire},${s},'${e}','${a.key}',${s+1},this.value)" ${canEdit(a.type)?"":'disabled'} class="w-full px-2 py-1 border rounded text-xs ${"yellow"===a.type?"bg-yellow-50":"bg-white"} ${canEdit(a.type)?"":"bg-gray-100"}"><option value="" ${i.evaluations?.[e]?.[a.key]?.[s+1]?"":"selected"}>S√©lectionner...</option><option value="Aucune" ${"Aucune"===i.evaluations?.[e]?.[a.key]?.[s+1]?"selected":""}>Aucune</option><option value="Faible" ${"Faible"===i.evaluations?.[e]?.[a.key]?.[s+1]?"selected":""}>Faible</option><option value="Mod√©r√©e" ${"Mod√©r√©e"===i.evaluations?.[e]?.[a.key]?.[s+1]?"selected":""}>Mod√©r√©e</option><option value="Bonne" ${"Bonne"===i.evaluations?.[e]?.[a.key]?.[s+1]?"selected":""}>Bonne</option><option value="Excellente" ${"Excellente"===i.evaluations?.[e]?.[a.key]?.[s+1]?"selected":""}>Excellente</option></select><textarea placeholder="Commentaire..." onchange="updateComment('${t.id}',${state.selectedBeneficiaire},${s},'${e}','${a.key}',this.value)" class="w-full px-2 py-1 border rounded text-xs bg-blue-50" rows="2">${i.commentaires?.[e]?.[a.key]||""}</textarea>`}</div>`:'<div class="text-xs text-gray-400 italic text-center">-</div>'}</td>`).join("")}${canEdit("white")?'<td class="px-4 py-3 border-l"></td>':""}</tr>`).join("")}</tbody></table></div></div>`).join("")}<div class="space-y-4 mb-6"><div><label class="block text-sm font-bold text-gray-900 mb-2">Compte-rendu du psychologue Mut</label><textarea placeholder="Compte-rendu..." onchange="updateBeneficiaire('${t.id}',${state.selectedBeneficiaire},'compteRenduMut',this.value)" ${canEdit("white")?"":'disabled'} class="w-full px-3 py-2 border rounded-lg ${canEdit("white")?"":"bg-gray-100"}" rows="5">${n.compteRenduMut}</textarea></div><div><label class="block text-sm font-bold text-gray-900 mb-2">Compte-rendu du psychologue de l'√©tablissement</label><textarea placeholder="Compte-rendu..." onchange="updateBeneficiaire('${t.id}',${state.selectedBeneficiaire},'compteRenduEtablissement',this.value)" ${canEdit("invite")?"":'disabled'} class="w-full px-3 py-2 border rounded-lg bg-green-50 ${canEdit("invite")?"":"bg-gray-100"}" rows="5">${n.compteRenduEtablissement}</textarea></div></div><div class="mt-6 flex justify-end"><button onclick="generatePDF('${t.id}',${state.selectedBeneficiaire})" class="flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-lg">üì• G√©n√©rer le Rapport PDF</button></div></div></div>`,void 0}if(state.expandedIntervention){const t=state.interventions[state.expandedIntervention];return e.innerHTML=`<div class="min-h-screen bg-gray-50"><header class="bg-white shadow-sm border-b sticky top-0 z-40"><div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between"><button onclick="backToList()" class="flex items-center gap-4 hover:opacity-80"><span class="text-4xl">üéµ</span><div><h1 class="text-2xl font-bold text-purple-900">Haltes Musicales</h1><p class="text-sm text-gray-600">${state.currentUser.name}</p></div></button><button onclick="logout()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">D√©connexion</button></div></header><div class="max-w-7xl mx-auto px-4 py-6"><button onclick="backToList()" class="mb-4 text-purple-600 hover:text-purple-700 font-medium">‚Üê Retour aux interventions</button><div class="bg-white rounded-xl shadow p-6 mb-6"><div class="flex justify-between items-start mb-4"><div><h2 class="text-2xl font-bold text-gray-900">${t.lieu}</h2><p class="text-gray-600 mt-1">${new Date(t.date).toLocaleDateString("fr-FR",{weekday:"long",year:"numeric",month:"long",day:"numeric"})} √† ${t.time}</p></div><button onclick="addBeneficiaire('${t.id}')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">+ Ajouter b√©n√©ficiaire</button></div></div>${!t.beneficiaires||0===t.beneficiaires.length?'<div class="bg-white rounded-xl p-12 text-center shadow"><p class="text-gray-400">Aucun b√©n√©ficiaire ajout√©</p></div>':`<div class="grid gap-4">${t.beneficiaires.map((e,t)=>`<div onclick="selectBeneficiaire(${t})" class="bg-white rounded-xl shadow hover:shadow-lg transition p-6 cursor-pointer"><div class="flex justify-between items-start"><div><h3 class="text-lg font-semibold text-gray-900">${e.beneficiaire.nom||"Nouveau"} ${e.beneficiaire.prenom||"b√©n√©ficiaire"}</h3>${e.beneficiaire.dateNaissance?`<p class="text-gray-600 text-sm mt-1">N√©(e) le ${new Date(e.beneficiaire.dateNaissance).toLocaleDateString("fr-FR")}</p>`:""}${e.pathologies?`<p class="text-gray-500 text-sm mt-2">${e.pathologies.substring(0,100)}${e.pathologies.length>100?"...":""}</p>`:""}</div><button class="text-purple-600 hover:text-purple-700 font-medium">Voir d√©tails ‚Üí</button></div></div>`).join("")}</div>`}</div></div>`,void 0}e.innerHTML=`<div class="min-h-screen bg-gray-50"><header class="bg-white shadow-sm border-b sticky top-0 z-40"><div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between"><div class="flex items-center gap-4"><span class="text-4xl">üéµ</span><div><h1 class="text-2xl font-bold text-purple-900">Haltes Musicales</h1><p class="text-sm text-gray-600">${state.currentUser.name}</p></div></div><button onclick="logout()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">D√©connexion</button></div></header><div class="max-w-7xl mx-auto px-4 py-6">${"professionnel"===state.currentUser.type?'<div class="mb-6 flex justify-end"><button onclick="showAddModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-lg flex items-center gap-2">+ Cr√©er une intervention</button></div>':""}${0===t.length?`<div class="bg-white rounded-xl p-12 text-center shadow"><div class="text-6xl mb-4">üìÖ</div><h3 class="text-xl font-semibold text-gray-900 mb-2">Aucune intervention</h3><p class="text-gray-500 mb-6">Commencez par ajouter une intervention</p>${"professionnel"===state.currentUser.type?'<button onclick="showAddModal()" class="inline-flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">+ Cr√©er une intervention</button>':""}</div>`:`<div class="grid gap-4">${t.map(e=>`<div class="bg-white rounded-xl shadow hover:shadow-lg transition p-6"><div class="flex justify-between items-start"><div onclick="viewIntervention('${e.id}')" class="cursor-pointer flex-1"><h3 class="text-lg font-semibold text-gray-900">${e.lieu}</h3><p class="text-gray-600 text-sm mt-1">${new Date(e.date).toLocaleDateString("fr-FR")} √† ${e.time}</p><p class="text-gray-500 text-sm mt-2">${e.beneficiaires?.length||0} b√©n√©ficiaire(s)</p></div><div class="flex gap-2 ml-4">${"professionnel"===state.currentUser.type?`<button onclick="event.stopPropagation(); copyInviteLink('${e.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm flex items-center gap-2" title="Partager avec l'√©tablissement">üîó Partager</button>`:""}<button onclick="viewIntervention('${e.id}')" class="text-purple-600 hover:text-purple-700 font-medium">Voir d√©tails ‚Üí</button></div></div></div>`).join("")}</div>`}</div></div>`}window.onload=init;
  </script>
</body>
</html>
