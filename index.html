<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Haltes Musicales</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script>
    const ADMIN_CODE = 'ADMIN2024';
    
    const EVALUATION_STRUCTURE = {
      interactionsSociales: {
        title: "INTERACTIONS SOCIALES",
        items: [
          { key: "attitudeHabituelle", label: "Attitude habituelle", moments: [1,2,3,4], type: "invite", fieldType: "text" },
          { key: "interaction", label: "Interaction Sociale (√©changes avec les personnes pr√©sentes)", moments: [1,2,3,4], type: "yellow" },
          { key: "reactionEmotionnelle", label: "R√©action √©motionnelle", moments: [1,2,3,4], type: "yellow" },
          { key: "reactionSuiteHalte", label: "R√©action suite √† la halte", moments: [1,2,3,4], type: "invite", fieldType: "text" }
        ]
      },
      stimulationSensorielle: {
        title: "STIMULATION MULTISENSORIELLE",
        items: [
          { key: "attitudeHabituelle", label: "Attitude habituelle", moments: [1,2,3,4], type: "invite", fieldType: "text" },
          { key: "reactionAuditive", label: "R√©action auditive (r√©ceptivit√© √† la musique)", moments: [1,2,3,4], type: "yellow" },
          { key: "reactionVisuelle", label: "R√©action visuelle (r√©ceptivit√© aux √©l√©ments visuels)", moments: [1,2,3,4], type: "yellow" },
          { key: "reactionKinesth", label: "R√©action kinesth√©sique (mouvement, danse)", moments: [1,2,3,4], type: "yellow" },
          { key: "reactionSuiteHalte", label: "R√©action suite √† la halte", moments: [1,2,3,4], type: "invite", fieldType: "text" }
        ]
      },
      memoire: {
        title: "M√âMOIRE / SOUVENIRS",
        items: [
          { key: "attitudeHabituelle", label: "Attitude habituelle", moments: [1,2,3,4], type: "invite", fieldType: "text" },
          { key: "reactivationSouvenirs", label: "R√©activation et verbalisation de souvenirs", moments: [1,2,3,4], type: "yellow" },
          { key: "reconnaissanceMusique", label: "Reconnaissance de la musique", moments: [1,2,3,4], type: "yellow" },
          { key: "reactionEmotionnelle2", label: "R√©action √©motionnelle", moments: [1,2,3,4], type: "yellow" },
          { key: "reactionSuiteHalte", label: "R√©action suite √† la halte", moments: [1,2,3,4], type: "invite", fieldType: "text" }
        ]
      },
      comportements: {
        title: "COMPORTEMENTS",
        items: [
          { key: "ideesDelirantes", label: "Id√©es d√©lirantes", moments: [1,2,3,4], type: "white" },
          { key: "hallucinations", label: "Hallucinations", moments: [1,2,3,4], type: "white" },
          { key: "agitation", label: "Agitation/Agressivit√©", moments: [1,2,3,4], type: "white" },
          { key: "depression", label: "D√©pression/Dysphorie", moments: [1,2,3,4], type: "white" },
          { key: "anxiete", label: "Anxi√©t√©", moments: [1,2,3,4], type: "white" },
          { key: "euphorie", label: "Exaltation de l'humeur / Euphorie", moments: [1,2,3,4], type: "white" },
          { key: "apathie", label: "Apathie / Indiff√©rence", moments: [1,2,3,4], type: "white" },
          { key: "desinhibition", label: "D√©sinhibition", moments: [1,2,3,4], type: "white" },
          { key: "irritabilite", label: "Irritabilit√© / Instabilit√© de l'humeur", moments: [1,2,3,4], type: "white" },
          { key: "moteurAberrant", label: "Comportement moteur aberrant", moments: [1,2,3,4], type: "white" }
        ]
      }
    };

    let state = {
      currentUser: null,
      users: { professionnels: [], invites: [] },
      interventions: {},
      view: 'signup',
      loginData: { email: '', password: '' },
      signupData: { name: '', email: '', password: '', type: 'professionnel', etablissement: '', rgpdConsent: false },
      loginError: '',
      newIntervention: { date: '', time: '', lieu: '' },
      expandedIntervention: null,
      selectedBeneficiaire: null
    };

    function init() {
      try {
        const usersData = localStorage.getItem('haltes_users');
        if (usersData) state.users = JSON.parse(usersData);
      } catch (e) {}
      render();
    }

    function showNotif(msg, type = 'success') {
      const notif = document.createElement('div');
      notif.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      notif.textContent = msg;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 3000);
    }

    function canEdit(fieldType) {
      if (!state.currentUser) return false;
      if (fieldType === 'comment') return true;
      if (fieldType === 'yellow') return true;
      if (fieldType === 'white') return state.currentUser.type === 'professionnel';
      if (fieldType === 'invite') return state.currentUser.type === 'invite';
      return false;
    }

    function createEmptyEvaluation() {
      return {
        id: Date.now().toString() + Math.random(),
        beneficiaire: { nom: '', prenom: '', dateNaissance: '', sexe: 'F√©minin' },
        pathologies: '', 
        souhaitsMusicaux: '',
        objectifs: '',
        compteRenduMut: '',
        compteRenduEtablissement: '',
        dates: [
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 1' },
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 2' },
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 3' },
          { date: '', evaluations: {}, commentaires: {}, label: 'Intervention 4' }
        ]
      };
    }

    function saveInterventions() {
      if (!state.currentUser || state.currentUser.type === 'admin') return;
      try {
        localStorage.setItem(`interventions_${state.currentUser.id}`, JSON.stringify(state.interventions));
      } catch (e) {
        console.error('Erreur sauvegarde', e);
      }
    }

    function updateBeneficiaire(interventionId, benefIndex, field, value) {
      const benef = state.interventions[interventionId].beneficiaires[benefIndex];
      if (field.includes('.')) {
        const [parent, child] = field.split('.');
        benef[parent][child] = value;
      } else {
        benef[field] = value;
      }
      saveInterventions();
    }

    function updateEvaluation(interventionId, benefIndex, dateIndex, category, itemKey, moment, value) {
      const benef = state.interventions[interventionId].beneficiaires[benefIndex];
      if (!benef.dates[dateIndex].evaluations[category]) {
        benef.dates[dateIndex].evaluations[category] = {};
      }
      if (!benef.dates[dateIndex].evaluations[category][itemKey]) {
        benef.dates[dateIndex].evaluations[category][itemKey] = {};
      }
      benef.dates[dateIndex].evaluations[category][itemKey][moment] = value;
      saveInterventions();
    }

    function updateComment(interventionId, benefIndex, dateIndex, category, itemKey, value) {
      const benef = state.interventions[interventionId].beneficiaires[benefIndex];
      if (!benef.dates[dateIndex].commentaires[category]) {
        benef.dates[dateIndex].commentaires[category] = {};
      }
      benef.dates[dateIndex].commentaires[category][itemKey] = value;
      saveInterventions();
    }

    function render() {
      const app = document.getElementById('app');
      
      if (!state.currentUser) {
        if (state.view === 'signup') {
          app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4">
              <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                  <span class="text-6xl">üéµ</span>
                  <h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Haltes Musicales</h1>
                  <p class="text-gray-600">Cr√©er votre compte</p>
                </div>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom complet *</label>
                    <input type="text" id="name" class="w-full px-4 py-3 border rounded-lg" placeholder="Dr. Marie Dupont">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                    <input type="email" id="email" class="w-full px-4 py-3 border rounded-lg" placeholder="email@exemple.fr">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe * (min. 8 car.)</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg" placeholder="********">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type *</label>
                    <select id="type" class="w-full px-4 py-3 border rounded-lg">
                      <option value="professionnel">Psychologue Haltes Musicales</option>
                      <option value="invite">√âtablissement (invit√©)</option>
                    </select>
                  </div>
                  <div id="etablissement-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">√âtablissement</label>
                    <input type="text" id="etablissement" class="w-full px-4 py-3 border rounded-lg" placeholder="EHPAD Les Jardins">
                  </div>
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <label class="flex items-start gap-3 text-sm">
                      <input type="checkbox" id="rgpd" class="mt-1">
                      <span>J'accepte la politique de confidentialit√© *</span>
                    </label>
                  </div>
                  ${state.loginError ? `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>` : ''}
                  <button onclick="handleSignup()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Cr√©er mon compte</button>
                  <button onclick="switchView('login')" class="w-full text-purple-600 hover:text-purple-700 text-sm font-medium">J'ai d√©j√† un compte</button>
                  <button onclick="switchView('admin')" class="w-full text-gray-400 hover:text-gray-600 text-xs pt-4 border-t">Acc√®s admin</button>
                </div>
              </div>
            </div>
          `;
          document.getElementById('type').addEventListener('change', (e) => {
            document.getElementById('etablissement-field').classList.toggle('hidden', e.target.value !== 'invite');
          });
        } else if (state.view === 'login') {
          app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4">
              <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                  <span class="text-6xl">üéµ</span>
                  <h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Haltes Musicales</h1>
                  <p class="text-gray-600">Connexion</p>
                </div>
                <div class="space-y-6">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-3 border rounded-lg" placeholder="email@exemple.fr">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg" placeholder="********">
                  </div>
                  ${state.loginError ? `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>` : ''}
                  <button onclick="handleLogin()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Se connecter</button>
                  <button onclick="switchView('signup')" class="w-full text-purple-600 hover:text-purple-700 text-sm font-medium">Cr√©er un compte</button>
                </div>
              </div>
            </div>
          `;
        } else if (state.view === 'admin') {
          app.innerHTML = `
            <div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-purple-50 flex items-center justify-center p-4">
              <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                <div class="text-center mb-8">
                  <span class="text-6xl">üîê</span>
                  <h1 class="text-3xl font-bold text-purple-900 mt-4 mb-2">Administration</h1>
                  <p class="text-gray-600">Acc√®s r√©serv√©</p>
                </div>
                <div class="space-y-6">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email administrateur</label>
                    <input type="text" id="email" class="w-full px-4 py-3 border rounded-lg" placeholder="admin">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                    <input type="password" id="password" class="w-full px-4 py-3 border rounded-lg" placeholder="Mot de passe">
                  </div>
                  ${state.loginError ? `<div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">${state.loginError}</div>` : ''}
                  <button onclick="handleLogin()" class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700">Se connecter</button>
                  <button onclick="switchView('signup')" class="w-full text-gray-600 hover:text-gray-800 text-sm">‚Üê Retour</button>
                </div>
              </div>
            </div>
          `;
        }
        return;
      }

      if (state.currentUser.type === 'admin') {
        app.innerHTML = `
          <div class="min-h-screen bg-gray-50">
            <header class="bg-white shadow-sm border-b sticky top-0 z-40">
              <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <span class="text-4xl">üéµ</span>
                  <div>
                    <h1 class="text-2xl font-bold text-purple-900">Administration</h1>
                    <p class="text-sm text-gray-600">Gestion des utilisateurs</p>
                  </div>
                </div>
                <button onclick="logout()" class="flex items-center gap-2 px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">D√©connexion</button>
              </div>
            </header>
            <div class="max-w-7xl mx-auto px-4 py-6">
              <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow p-6">
                  <h3 class="text-lg font-bold text-gray-900 mb-4">Psychologues (${state.users.professionnels.length})</h3>
                  <div class="space-y-3">
                    ${state.users.professionnels.map(u => `
                      <div class="p-3 bg-purple-50 rounded-lg">
                        <p class="font-medium text-gray-900">${u.name}</p>
                        <p class="text-sm text-gray-600">${u.email}</p>
                      </div>
                    `).join('') || '<p class="text-gray-400 text-sm">Aucun psychologue</p>'}
                  </div>
                </div>
                <div class="bg-white rounded-xl shadow p-6">
                  <h3 class="text-lg font-bold text-gray-900 mb-4">√âtablissements (${state.users.invites.length})</h3>
                  <div class="space-y-3">
                    ${state.users.invites.map(u => `
                      <div class="p-3 bg-blue-50 rounded-lg">
                        <p class="font-medium text-gray-900">${u.name}</p>
                        <p class="text-sm text-gray-600">${u.email}</p>
                        ${u.etablissement ? `<p class="text-xs text-gray-500">${u.etablissement}</p>` : ''}
                      </div>
                    `).join('') || '<p class="text-gray-400 text-sm">Aucun √©tablissement</p>'}
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        return;
      }

      const interventionsList = Object.values(state.interventions).filter(i => i.createdBy === state.currentUser.id).sort((a,b) => new Date(b.date) - new Date(a.date));
      
      if (state.expandedIntervention && state.selectedBeneficiaire !== null) {
        const intervention = state.interventions[state.expandedIntervention];
        const benef = intervention.beneficiaires[state.selectedBeneficiaire];
        
        app.innerHTML = `
          <div class="min-h-screen bg-gray-50">
            <header class="bg-white shadow-sm border-b sticky top-0 z-40">
              <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="backToBeneficiaires()" class="flex items-center gap-4 hover:opacity-80">
                  <span class="text-4xl">üéµ</span>
                  <div>
                    <h1 class="text-2xl font-bold text-purple-900">Haltes Musicales</h1>
                    <p class="text-sm text-gray-600">${benef.beneficiaire.nom} ${benef.beneficiaire.prenom}</p>
                  </div>
                </button>
                <button onclick="logout()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">D√©connexion</button>
              </div>
            </header>
            <div class="max-w-7xl mx-auto px-4 py-6">
              <button onclick="backToBeneficiaires()" class="mb-4 text-purple-600 hover:text-purple-700 font-medium">‚Üê Retour aux b√©n√©ficiaires</button>
              
              <div class="bg-white rounded-xl shadow p-6 mb-6">
                <h4 class="text-lg font-bold text-gray-900 mb-4">Informations du b√©n√©ficiaire</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <input type="text" placeholder="Nom" value="${benef.beneficiaire.nom}" onchange="updateBeneficiaire('${intervention.id}', ${state.selectedBeneficiaire}, 'beneficiaire.nom', this.value)" ${!canEdit('white') ? 'disabled' : ''} class="px-3 py-2 border rounded-lg ${!canEdit('white') ? 'bg-gray-100' : ''}">
                  <input type="text" placeholder="Pr√©nom" value="${benef.beneficiaire.prenom}" onchange="updateBeneficiaire('${intervention.id}', ${state.selectedBeneficiaire}, 'beneficiaire.prenom', this.value)" ${!canEdit('white') ? 'disabled' : ''} class="px-3 py-2 border rounded-lg ${!canEdit('white') ? 'bg-gray-100' : ''}">
                  <input type="date" value="${benef.beneficiaire.dateNaissance}" onchange="updateBeneficiaire('${intervention.id}', ${state.selectedBeneficiaire}, 'beneficiaire.dateNaissance', this.value)" ${!canEdit('white') ? 'disabled' : ''} class="px-3 py-2 border rounded-lg ${!canEdit('white') ? 'bg-gray-100' : ''}">
                  <select onchange="updateBeneficiaire('${intervention.id}', ${state.selectedBeneficiaire}, 'beneficiaire.sexe', this.value)" ${!canEdit('white') ? 'disabled' : ''} class="px-3 py-2 border rounded-lg ${!canEdit('white') ? 'bg-gray-100' : ''}">
                    <option ${benef.beneficiaire.sexe === 'F√©minin' ? 'selected' : ''}>F√©minin</option>
                    <option ${benef.beneficiaire.sexe === 'Masculin' ? 'selected' : ''}>Masculin</option>
                  </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                  <textarea placeholder="Pathologies" onchange="updateBeneficiaire('${intervention.id}', ${state.selectedBeneficiaire}, 'pathologies', this.value)" ${!canEdit('white') ? 'disabled' : ''} class="px-3 py-2 border rounded-lg ${!canEdit('white') ? 'bg-gray-100' : ''}" rows="2">${benef.pathologies}</textarea>
                  <textarea placeholder="Souhaits musicaux" onchange="updateBeneficiaire('${intervention.id}', ${state.selectedBeneficiaire}, 'souhaitsMusicaux', this.value)" ${!canEdit('white') ? 'disabled' : ''} class="px-3 py-2 border rounded-lg ${!canEdit('white') ? 'bg-gray-100' : ''}" rows="2">${benef.souhaitsMusicaux}</textarea>
                </div>
                <div class="mt-4">
                  <textarea placeholder="Objectifs de l'√©tablissement" onchange="updateBeneficiaire('${intervention.id}', ${state.selectedBeneficiaire}, 'objectifs', this.value)" ${!canEdit('white') ? 'disabled' : ''} class="w-full px-3 py-2 border rounded-lg ${!canEdit('white') ? 'bg-gray-100' : ''}" rows="3">${benef.objectifs}</textarea>
                </div>
              </div>

              ${Object.entries(EVALUATION_STRUCTURE).map(([catKey, category]) => `
                <div class="border rounded-lg overflow-hidden mb-6">
                  <h6 class="font-bold text-gray-900 p-4 bg-orange-50 border-b">${category.title}</h6>
                  <div class="overflow-x-auto">
                    <table class="w-full">
                      <thead>
                        <tr class="bg-gray-50 border-b">
                          <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700 w-1/4">Crit√®re</th>
                          ${benef.dates.map((dateObj, dateIdx) => `
                            <th class="px-4 py-3 text-center text-sm font-semibold text-purple-700 border-l">
                              <div>${dateObj.label}</div>
                              ${dateObj.date ? `<div class="text-xs text-gray-500 font-normal mt-1">${new Date(dateObj.date).toLocaleDateString('fr-FR')}</div>` : ''}
                            </th>
                          `).join('')}
                        </tr>
                      </thead>
                      <tbody>
                        ${category.items.map((item, idx) => `
                          <tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                            <td class="px-4 py-3 text-sm ${item.type === 'yellow' ? 'bg-yellow-50 font-medium' : item.type === 'invite' ? 'bg-green-50 font-medium italic' : 'bg-gray-50 font-medium'}">${item.label}</td>
                            ${benef.dates.map((dateObj, dateIdx) => `
                              <td class="px-4 py-3 border-l">
                                ${item.moments.includes(dateIdx + 1) || dateIdx >= 4 ? `
                                  <div class="space-y-2">
                                    ${item.fieldType === 'text' ? `
                                      <textarea
                                        onchange="updateEvaluation('${intervention.id}', ${state.selectedBeneficiaire}, ${dateIdx}, '${catKey}', '${item.key}', ${dateIdx + 1}, this.value)"
                                        ${!canEdit(item.type) ? 'disabled' : ''}
                                        placeholder="Texte libre..."
                                        class="w-full px-2 py-1 border rounded text-xs ${item.type === 'invite' ? 'bg-green-50' : 'bg-white'} ${!canEdit(item.type) ? 'bg-gray-100' : ''}"
                                        rows="3"
                                      >${dateObj.evaluations?.[catKey]?.[item.key]?.[dateIdx + 1] || ''}</textarea>
                                    ` : `
                                      <select
                                        onchange="updateEvaluation('${intervention.id}', ${state.selectedBeneficiaire}, ${dateIdx}, '${catKey}', '${item.key}', ${dateIdx + 1}, this.value)"
                                        ${!canEdit(item.type) ? 'disabled' : ''}
                                        class="w-full px-2 py-1 border rounded text-xs ${item.type === 'yellow' ? 'bg-yellow-50' : 'bg-white'} ${!canEdit(item.type) ? 'bg-gray-100' : ''}"
                                      >
                                        ${catKey === 'comportements' ? `
                                          <option value="" ${!dateObj.evaluations?.[catKey]?.[item.key]?.[dateIdx + 1] ? 'selected' : ''}>S√©lectionner...</option>
                                          <option value="Aucune" ${dateObj.evaluations?.[catKey]?.[item.key]?.[dateIdx + 1] === 'Aucune' ? 'selected' : ''}>Aucune</option>
                                          <option value="Faible" ${dateObj.evaluations?.[catKey]?.[item.key]?.[dateIdx + 1] === 'Faible' ? 'selected' : ''}>Faible</option>
                                          <option value="Mod√©r√©e" ${dateObj.evaluations?.[catKey]?.[item.key]?.[dateIdx + 1] === 'Mod√©r√©e' ? 'selected' : ''}>Mod√©r√©e</option>
                                          <option value="Bonne" ${dateObj.evaluations?.[catKey]?.[item.key]?.[dateIdx + 1] === 'Bonne' ? 'selected' : ''}>Bonne</option>
                                          <option value="Excellente" ${dateObj.evaluations?.[catKey]?.[item.key]?.[dateIdx + 1] === 'Excellente' ? 'selected' : ''}>Excellente</option>
                                        `}
                                      </select>
                                      <textarea
                                        placeholder="Commentaire..."
                                        onchange="updateComment('${intervention.id}', ${state.selectedBeneficiaire}, ${dateIdx}, '${catKey}', '${item.key}', this.value)"
                                        class="w-full px-2 py-1 border rounded text-xs bg-blue-50"
                                        rows="2"
                                      >${dateObj.commentaires?.[catKey]?.[item.key] || ''}</textarea>
                                    `}
                                  </div>
                                ` : `<div class="text-xs text-gray-400 italic text-center">-</div>`}
                              </td>
                            `).join('')}
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              `).join('')}

              <div class="space-y-4 mb-6">
                <div>
                  <label class="block text-sm font-bold text-gray-900 mb-2">Compte-rendu du psychologue Mut</label>
                  <textarea 
                    placeholder="Compte-rendu..."
                    onchange="updateBeneficiaire('${intervention.id}', ${state.selectedBeneficiaire}, 'compteRenduMut', this.value)"
                    ${!canEdit('white') ? 'disabled' : ''}
                    class="w-full px-3 py-2 border rounded-lg ${!canEdit('white') ? 'bg-gray-100' : ''}" 
                    rows="5"
                  >${benef.compteRenduMut}</textarea>
                </div>
                <div>
                  <label class="block text-sm font-bold text-gray-900 mb-2">Compte-rendu du psychologue de l'√©tablissement</label>
                  <textarea 
                    placeholder="Compte-rendu..."
                    onchange="updateBeneficiaire('${intervention.id}', ${state.selectedBeneficiaire}, 'compteRenduEtablissement', this.value)"
                    ${!canEdit('invite') ? 'disabled' : ''}
                    class="w-full px-3 py-2 border rounded-lg bg-green-50 ${!canEdit('invite') ? 'bg-gray-100' : ''}" 
                    rows="5"
                  >${benef.compteRenduEtablissement}</textarea>
                </div>
              </div>

              <div class="mt-6 flex justify-end">
                <button onclick="showNotif('Fonctionnalit√© PDF en d√©veloppement')" class="flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 shadow-lg">
                  üì• G√©n√©ration PDF
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (state.expandedIntervention) {
        const intervention = state.interventions[state.expandedIntervention];
        
        app.innerHTML = `
          <div class="min-h-screen bg-gray-50">
            <header class="bg-white shadow-sm border-b sticky top-0 z-40">
              <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <button onclick="backToList()" class="flex items-center gap-4 hover:opacity-80">
                  <span class="text-4xl">üéµ</span>
                  <div>
                    <h1 class="text-2xl font-bold text-purple-900">Haltes Musicales</h1>
                    <p class="text-sm text-gray-600">${state.currentUser.name}</p>
                  </div>
                </button>
                <button onclick="logout()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">D√©connexion</button>
              </div>
            </header>
            <div class="max-w-7xl mx-auto px-4 py-6">
              <button onclick="backToList()" class="mb-4 text-purple-600 hover:text-purple-700 font-medium">‚Üê Retour aux interventions</button>
              
              <div class="bg-white rounded-xl shadow p-6 mb-6">
                <div class="flex justify-between items-start mb-4">
                  <div>
                    <h2 class="text-2xl font-bold text-gray-900">${intervention.lieu}</h2>
                    <p class="text-gray-600 mt-1">${new Date(intervention.date).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} √† ${intervention.time}</p>
                  </div>
                  ${state.currentUser.type === 'professionnel' ? `
                    <button onclick="addBeneficiaire('${intervention.id}')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2">
                      + Ajouter b√©n√©ficiaire
                    </button>
                  ` : ''}
                </div>
              </div>

              ${!intervention.beneficiaires || intervention.beneficiaires.length === 0 ? `
                <div class="bg-white rounded-xl p-12 text-center shadow">
                  <p class="text-gray-400">Aucun b√©n√©ficiaire ajout√©</p>
                </div>
              ` : `
                <div class="grid gap-4">
                  ${intervention.beneficiaires.map((benef, bIndex) => `
                    <div onclick="selectBeneficiaire(${bIndex})" class="bg-white rounded-xl shadow hover:shadow-lg transition p-6 cursor-pointer">
                      <div class="flex justify-between items-start">
                        <div>
                          <h3 class="text-lg font-semibold text-gray-900">${benef.beneficiaire.nom || 'Nouveau'} ${benef.beneficiaire.prenom || 'b√©n√©ficiaire'}</h3>
                          ${benef.beneficiaire.dateNaissance ? `<p class="text-gray-600 text-sm mt-1">N√©(e) le ${new Date(benef.beneficiaire.dateNaissance).toLocaleDateString('fr-FR')}</p>` : ''}
                          ${benef.pathologies ? `<p class="text-gray-500 text-sm mt-2">${benef.pathologies.substring(0, 100)}${benef.pathologies.length > 100 ? '...' : ''}</p>` : ''}
                        </div>
                        <button class="text-purple-600 hover:text-purple-700 font-medium">
                          Voir d√©tails ‚Üí
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        `;
      } else {
        app.innerHTML = `
          <div class="min-h-screen bg-gray-50">
            <header class="bg-white shadow-sm border-b sticky top-0 z-40">
              <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <span class="text-4xl">üéµ</span>
                  <div>
                    <h1 class="text-2xl font-bold text-purple-900">Haltes Musicales</h1>
                    <p class="text-sm text-gray-600">${state.currentUser.name}</p>
                  </div>
                </div>
                <button onclick="logout()" class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg">D√©connexion</button>
              </div>
            </header>
            <div class="max-w-7xl mx-auto px-4 py-6">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900">Mes Interventions (${interventionsList.length})</h2>
                ${state.currentUser.type === 'professionnel' ? `
                  <button onclick="showAddModal()" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 shadow-lg">
                    + Nouvelle intervention
                  </button>
                ` : ''}
              </div>

              ${interventionsList.length === 0 ? `
                <div class="bg-white rounded-xl p-12 text-center shadow">
                  <div class="text-6xl mb-4">üìÖ</div>
                  <h3 class="text-xl font-semibold text-gray-900 mb-2">Aucune intervention</h3>
                  <p class="text-gray-500 mb-6">Commencez par ajouter une intervention</p>
                  ${state.currentUser.type === 'professionnel' ? `
                    <button onclick="showAddModal()" class="inline-flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                      + Cr√©er une intervention
                    </button>
                  ` : ''}
                </div>
              ` : `
                <div class="grid gap-4">
                  ${interventionsList.map(intervention => `
                    <div onclick="viewIntervention('${intervention.id}')" class="bg-white rounded-xl shadow hover:shadow-lg transition p-6 cursor-pointer">
                      <div class="flex justify-between items-start">
                        <div>
                          <h3 class="text-lg font-semibold text-gray-900">${intervention.lieu}</h3>
                          <p class="text-gray-600 text-sm mt-1">${new Date(intervention.date).toLocaleDateString('fr-FR')} √† ${intervention.time}</p>
                          <p class="text-gray-500 text-sm mt-2">${intervention.beneficiaires?.length || 0} b√©n√©ficiaire(s)</p>
                        </div>
                        <button class="text-purple-600 hover:text-purple-700 font-medium">
                          Voir d√©tails ‚Üí
                        </button>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
            </div>
          </div>
        `;
      }
    }

    function switchView(view) {
      state.view = view;
      state.loginError = '';
      render();
    }

    function handleSignup() {
      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const type = document.getElementById('type').value;
      const etablissement = document.getElementById('etablissement')?.value || '';
      const rgpdConsent = document.getElementById('rgpd').checked;

      if (!name || !email || !password) {
        showNotif('Remplissez tous les champs obligatoires', 'error');
        return;
      }
      if (password.length < 8) {
        showNotif('Le mot de passe doit contenir au moins 8 caract√®res', 'error');
        return;
      }
      if (!rgpdConsent) {
        showNotif('Vous devez accepter la politique de confidentialit√©', 'error');
        return;
      }

      const allUsers = [...state.users.professionnels, ...state.users.invites];
      if (allUsers.find(u => u.email === email)) {
        showNotif('Cet email existe d√©j√†', 'error');
        return;
      }

      const id = Date.now().toString();
      const user = { name, email, password, type, id, etablissement, createdAt: new Date().toISOString(), rgpdConsent: true };
      
      if (type === 'professionnel') {
        state.users.professionnels.push(user);
      } else {
        state.users.invites.push(user);
      }
      
      localStorage.setItem('haltes_users', JSON.stringify(state.users));
      state.currentUser = user;
      
      try {
        const data = localStorage.getItem(`interventions_${user.id}`);
        state.interventions = data ? JSON.parse(data) : {};
      } catch (e) {
        state.interventions = {};
      }
      
      showNotif('Compte cr√©√© avec succ√®s !');
      render();
    }

    function handleLogin() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      if (email === 'admin' && password === ADMIN_CODE) {
        state.currentUser = { type: 'admin', name: 'Administrateur', id: 'admin' };
        showNotif('Bienvenue Administrateur !');
        render();
        return;
      }

      const allUsers = [...state.users.professionnels, ...state.users.invites];
      const user = allUsers.find(u => u.email === email && u.password === password);
      
      if (user) {
        state.currentUser = user;
        try {
          const data = localStorage.getItem(`interventions_${user.id}`);
          state.interventions = data ? JSON.parse(data) : {};
        } catch (e) {
          state.interventions = {};
        }
        showNotif(`Bienvenue ${user.name} !`);
        render();
      } else {
        state.loginError = 'Email ou mot de passe incorrect';
        render();
      }
    }

    function logout() {
      state.currentUser = null;
      state.interventions = {};
      state.view = 'signup';
      state.expandedIntervention = null;
      state.selectedBeneficiaire = null;
      render();
    }

    function showAddModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-900">Nouvelle intervention</h3>
            <button onclick="this.closest('div').parentElement.remove()" class="text-gray-400 hover:text-gray-600">
              <span class="text-2xl">√ó</span>
            </button>
          </div>
          <div class="space-y-4">
            <input type="date" id="modal-date" class="w-full px-4 py-2 border rounded-lg">
            <input type="time" id="modal-time" class="w-full px-4 py-2 border rounded-lg">
            <input type="text" id="modal-lieu" placeholder="Lieu" class="w-full px-4 py-2 border rounded-lg">
            <div class="flex gap-3">
              <button onclick="this.closest('div').parentElement.parentElement.remove()" class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">Annuler</button>
              <button onclick="saveIntervention(this)" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Ajouter</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function saveIntervention(btn) {
      const date = document.getElementById('modal-date').value;
      const time = document.getElementById('modal-time').value;
      const lieu = document.getElementById('modal-lieu').value;

      if (!date || !time || !lieu) {
        showNotif('Remplissez tous les champs', 'error');
        return;
      }

      const id = Date.now().toString();
      state.interventions[id] = {
        id, date, time, lieu,
        beneficiaires: [],
        createdBy: state.currentUser.id,
        createdByName: state.currentUser.name,
        createdByType: state.currentUser.type,
        etablissement: state.currentUser.etablissement || ''
      };

      saveInterventions();
      btn.closest('div').parentElement.parentElement.remove();
      showNotif('Intervention cr√©√©e !');
      render();
    }

    function viewIntervention(id) {
      state.expandedIntervention = id;
      state.selectedBeneficiaire = null;
      render();
    }

    function backToList() {
      state.expandedIntervention = null;
      state.selectedBeneficiaire = null;
      render();
    }

    function backToBeneficiaires() {
      state.selectedBeneficiaire = null;
      render();
    }

    function selectBeneficiaire(index) {
      state.selectedBeneficiaire = index;
      render();
    }

    function addBeneficiaire(interventionId) {
      const benef = createEmptyEvaluation();
      
      if (!state.interventions[interventionId].beneficiaires) {
        state.interventions[interventionId].beneficiaires = [];
      }
      state.interventions[interventionId].beneficiaires.push(benef);
      
      saveInterventions();
      showNotif('B√©n√©ficiaire ajout√© !');
      render();
    }

    window.onload = init;
  </script>
</body>
</html>Absent</option>
                                          <option value="1" ${dateObj.evaluations?.[catKey]?.[item.key]?.[dateIdx + 1] === '1' ? 'selected' : ''}>L√©ger</option>
                                          <option value="2" ${dateObj.evaluations?.[catKey]?.[item.key]?.[dateIdx + 1] === '2' ? 'selected' : ''}>Mod√©r√©</option>
                                          <option value="3" ${dateObj.evaluations?.[catKey]?.[item.key]?.[dateIdx + 1] === '3' ? 'selected' : ''}>S√©v√®re</option>
                                        ` : `
                                          <option value="" ${!dateObj.evaluations?.[catKey]?.[item.key]?.[dateIdx + 1] ? 'selected' : ''}>
